---
phase: 02-url-preservation-routing
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - app/Console/Commands/VerifyUrls.php
autonomous: true

must_haves:
  truths:
    - "Command tests all published post URLs"
    - "Command tests all page URLs"
    - "Command tests all category URLs"
    - "Command tests all tag URLs"
    - "Command reports failures clearly"
  artifacts:
    - path: "app/Console/Commands/VerifyUrls.php"
      provides: "URL verification Artisan command"
      contains: "Http::get"
  key_links:
    - from: "VerifyUrls command"
      to: "Post, Page, Category, Tag models"
      via: "URL generation from models"
      pattern: "->url"
---

<objective>
Create custom Artisan command to verify all migrated WordPress URLs resolve correctly in Laravel.

Purpose: Success criteria requires "100% of exported WordPress URLs resolve without 404s". This command automates that verification.
Output: `php artisan urls:verify` command that tests all content URLs and reports failures
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-url-preservation-routing/02-RESEARCH.md
@app/Models/Post.php
@app/Models/Page.php
@app/Models/Category.php
@app/Models/Tag.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifyUrls Artisan command</name>
  <files>app/Console/Commands/VerifyUrls.php</files>
  <action>
Create a comprehensive URL verification command:

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Http;
use App\Models\Post;
use App\Models\Page;
use App\Models\Category;
use App\Models\Tag;

class VerifyUrls extends Command
{
    protected $signature = 'urls:verify
                            {--type=all : Type to verify (posts, pages, categories, tags, all)}
                            {--limit=0 : Limit number of URLs to test (0 = all)}
                            {--base-url= : Override APP_URL for testing}';

    protected $description = 'Verify all migrated WordPress URLs return 200 status';

    protected array $failures = [];
    protected int $successCount = 0;
    protected int $testedCount = 0;

    public function handle(): int
    {
        $baseUrl = $this->option('base-url') ?: config('app.url');
        $type = $this->option('type');
        $limit = (int) $this->option('limit');

        $this->info("Verifying URLs against: {$baseUrl}");
        $this->info("Type: {$type}" . ($limit ? ", Limit: {$limit}" : ''));
        $this->newLine();

        if (in_array($type, ['all', 'posts'])) {
            $this->verifyPosts($baseUrl, $limit);
        }

        if (in_array($type, ['all', 'pages'])) {
            $this->verifyPages($baseUrl, $limit);
        }

        if (in_array($type, ['all', 'categories'])) {
            $this->verifyCategories($baseUrl, $limit);
        }

        if (in_array($type, ['all', 'tags'])) {
            $this->verifyTags($baseUrl, $limit);
        }

        $this->newLine();
        $this->info("=== SUMMARY ===");
        $this->info("Tested: {$this->testedCount}");
        $this->info("Passed: {$this->successCount}");
        $this->info("Failed: " . count($this->failures));

        if (count($this->failures) > 0) {
            $this->newLine();
            $this->error('FAILURES:');
            $this->table(
                ['Type', 'URL', 'Status', 'Expected'],
                array_map(fn($f) => [
                    $f['type'],
                    $f['url'],
                    $f['status'],
                    '200',
                ], array_slice($this->failures, 0, 50))
            );

            if (count($this->failures) > 50) {
                $this->warn('Showing first 50 failures. Total: ' . count($this->failures));
            }

            // Save full failure report to file
            $reportPath = storage_path('logs/url-failures-' . now()->format('Y-m-d-His') . '.json');
            file_put_contents($reportPath, json_encode($this->failures, JSON_PRETTY_PRINT));
            $this->info("Full failure report saved to: {$reportPath}");

            return Command::FAILURE;
        }

        $this->info('All URLs verified successfully!');
        return Command::SUCCESS;
    }

    protected function verifyPosts(string $baseUrl, int $limit): void
    {
        $query = Post::published()->select(['id', 'slug', 'published_at']);
        if ($limit > 0) {
            $query->limit($limit);
        }
        $total = $limit > 0 ? min($limit, Post::published()->count()) : Post::published()->count();

        $this->info("Verifying posts ({$total})...");
        $bar = $this->output->createProgressBar($total);

        $query->chunk(100, function ($posts) use ($baseUrl, $bar) {
            foreach ($posts as $post) {
                $this->testUrl($baseUrl . $post->url, 'post');
                $bar->advance();
            }
        });

        $bar->finish();
        $this->newLine();
    }

    protected function verifyPages(string $baseUrl, int $limit): void
    {
        $query = Page::select(['id', 'slug']);
        if ($limit > 0) {
            $query->limit($limit);
        }
        $total = $limit > 0 ? min($limit, Page::count()) : Page::count();

        $this->info("Verifying pages ({$total})...");
        $bar = $this->output->createProgressBar($total);

        $query->chunk(50, function ($pages) use ($baseUrl, $bar) {
            foreach ($pages as $page) {
                $this->testUrl($baseUrl . $page->url, 'page');
                $bar->advance();
            }
        });

        $bar->finish();
        $this->newLine();
    }

    protected function verifyCategories(string $baseUrl, int $limit): void
    {
        $query = Category::select(['id', 'slug']);
        if ($limit > 0) {
            $query->limit($limit);
        }
        $total = $limit > 0 ? min($limit, Category::count()) : Category::count();

        $this->info("Verifying categories ({$total})...");
        $bar = $this->output->createProgressBar($total);

        foreach ($query->get() as $category) {
            $this->testUrl($baseUrl . $category->url, 'category');
            $bar->advance();
        }

        $bar->finish();
        $this->newLine();
    }

    protected function verifyTags(string $baseUrl, int $limit): void
    {
        $query = Tag::select(['id', 'slug']);
        if ($limit > 0) {
            $query->limit($limit);
        }
        $total = $limit > 0 ? min($limit, Tag::count()) : Tag::count();

        $this->info("Verifying tags ({$total})...");
        $bar = $this->output->createProgressBar($total);

        $query->chunk(200, function ($tags) use ($baseUrl, $bar) {
            foreach ($tags as $tag) {
                $this->testUrl($baseUrl . $tag->url, 'tag');
                $bar->advance();
            }
        });

        $bar->finish();
        $this->newLine();
    }

    protected function testUrl(string $url, string $type): void
    {
        $this->testedCount++;

        try {
            $response = Http::timeout(10)
                ->withoutVerifying()  // Skip SSL for local testing
                ->get($url);

            if ($response->status() === 200) {
                $this->successCount++;
            } else {
                $this->failures[] = [
                    'type' => $type,
                    'url' => $url,
                    'status' => $response->status(),
                ];
            }
        } catch (\Exception $e) {
            $this->failures[] = [
                'type' => $type,
                'url' => $url,
                'status' => 'error: ' . class_basename($e) . ' - ' . substr($e->getMessage(), 0, 50),
            ];
        }
    }
}
```

**Key features:**
- `--type` flag to test specific content types (useful for debugging)
- `--limit` flag to test a sample (useful for quick checks)
- `--base-url` flag to override APP_URL (for testing against staging)
- Progress bars for large datasets
- Saves full failure report to JSON file
- Chunked queries for memory efficiency
- 10-second timeout per request
  </action>
  <verify>
Test with a sample:
```bash
# Quick test with limit
php artisan urls:verify --limit=10

# Test specific type
php artisan urls:verify --type=posts --limit=5

# Full test (requires server running)
php artisan serve &
php artisan urls:verify --limit=50
```
  </verify>
  <done>urls:verify command tests all content URLs and reports failures with progress bars</done>
</task>

<task type="auto">
  <name>Task 2: Add quick-check alias command</name>
  <files>app/Console/Commands/VerifyUrls.php</files>
  <action>
Add a quick-check mode that samples URLs for fast verification:

Update the command signature to include a quick flag:

```php
protected $signature = 'urls:verify
                        {--type=all : Type to verify (posts, pages, categories, tags, all)}
                        {--limit=0 : Limit number of URLs to test (0 = all)}
                        {--base-url= : Override APP_URL for testing}
                        {--quick : Quick check - sample 10 from each type}';
```

In the handle() method, add at the top:

```php
if ($this->option('quick')) {
    $limit = 10;
    $this->info('Quick check mode: testing 10 URLs per type');
}
```

Also update where $limit is assigned:

```php
$limit = $this->option('quick') ? 10 : (int) $this->option('limit');
```

This allows rapid verification during development without testing all 3,870+ posts.
  </action>
  <verify>
```bash
php artisan urls:verify --quick
```
Should complete quickly, testing ~40 URLs total (10 posts, 10 pages, 10 categories, 10 tags)
  </verify>
  <done>--quick flag enables rapid sampling verification</done>
</task>

</tasks>

<verification>
1. `php artisan urls:verify --quick` completes in under 30 seconds
2. `php artisan urls:verify --type=posts --limit=10` tests only posts
3. Command shows progress bars for each content type
4. Failures are clearly reported with URL and status
5. Full failure report saved to storage/logs when failures occur
</verification>

<success_criteria>
- urls:verify command tests all content types
- --type, --limit, --quick flags work correctly
- Progress bars show for large datasets
- Failures reported with clear summary table
- Full failure report persisted to JSON file
- Memory efficient with chunked queries
</success_criteria>

<output>
After completion, create `.planning/phases/02-url-preservation-routing/02-05-SUMMARY.md`
</output>
