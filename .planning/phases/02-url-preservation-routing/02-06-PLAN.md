---
phase: 02-url-preservation-routing
plan: 06
type: execute
wave: 3
depends_on: ["02-01"]
files_modified:
  - app/Http/Middleware/TrailingSlashRedirect.php
  - bootstrap/app.php
autonomous: true

must_haves:
  truths:
    - "URLs without trailing slash redirect to version with trailing slash"
    - "Redirect is 301 (permanent) for SEO"
    - "Homepage doesn't redirect redundantly"
  artifacts:
    - path: "app/Http/Middleware/TrailingSlashRedirect.php"
      provides: "Trailing slash enforcement middleware"
      contains: "301"
  key_links:
    - from: "bootstrap/app.php"
      to: "TrailingSlashRedirect middleware"
      via: "withMiddleware registration"
      pattern: "TrailingSlashRedirect"
---

<objective>
Create middleware to enforce trailing slash convention matching WordPress URLs.

Purpose: WordPress uses trailing slashes on all URLs. Inconsistency causes duplicate content issues for SEO. All non-trailing URLs should 301 redirect to trailing versions.
Output: Middleware that redirects /2015/08/15/slug to /2015/08/15/slug/ with 301
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-url-preservation-routing/02-RESEARCH.md
@bootstrap/app.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrailingSlashRedirect middleware</name>
  <files>app/Http/Middleware/TrailingSlashRedirect.php</files>
  <action>
Create middleware to enforce trailing slashes:

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class TrailingSlashRedirect
{
    /**
     * Redirect URLs without trailing slashes to versions with trailing slashes.
     * This matches WordPress permalink behavior for SEO consistency.
     */
    public function handle(Request $request, Closure $next): Response
    {
        // Skip for non-GET requests (POST, etc.)
        if (!$request->isMethod('GET')) {
            return $next($request);
        }

        $path = $request->getPathInfo();

        // Skip if already has trailing slash
        if (str_ends_with($path, '/')) {
            return $next($request);
        }

        // Skip if path has a file extension (assets, sitemap.xml, etc.)
        if (preg_match('/\.[a-zA-Z0-9]+$/', $path)) {
            return $next($request);
        }

        // Build redirect URL with trailing slash
        $url = $request->getSchemeAndHttpHost() . $path . '/';

        // Preserve query string if present
        if ($request->getQueryString()) {
            $url .= '?' . $request->getQueryString();
        }

        // 301 permanent redirect for SEO
        return redirect($url, 301);
    }
}
```

**Key implementation details:**
- Only applies to GET requests (don't break form submissions)
- Skips paths with file extensions (sitemap.xml, robots.txt, images)
- Preserves query strings
- Uses 301 for SEO (signals permanent redirect to search engines)
  </action>
  <verify>
Verify file exists:
```bash
cat app/Http/Middleware/TrailingSlashRedirect.php | grep "class TrailingSlashRedirect"
```
  </verify>
  <done>TrailingSlashRedirect middleware created with 301 redirect logic</done>
</task>

<task type="auto">
  <name>Task 2: Register middleware in bootstrap/app.php</name>
  <files>bootstrap/app.php</files>
  <action>
Register the trailing slash middleware globally in Laravel 12's bootstrap/app.php:

The current bootstrap/app.php should already have a structure like:

```php
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        //
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })->create();
```

Update the `withMiddleware` section to include the trailing slash redirect:

```php
->withMiddleware(function (Middleware $middleware) {
    // Enforce trailing slashes on URLs (WordPress compatibility)
    $middleware->web(append: [
        \App\Http\Middleware\TrailingSlashRedirect::class,
    ]);
})
```

**Note:** The middleware is appended to the web group, so it runs for all web routes.
  </action>
  <verify>
Test redirect behavior:
```bash
# Start server if not running
php artisan serve &

# Test trailing slash redirect (should 301 to /category/marketing/)
curl -I http://localhost:8000/category/marketing

# Test that trailing slash works directly (should 200)
curl -I http://localhost:8000/category/marketing/

# Test that files are not redirected
curl -I http://localhost:8000/sitemap.xml
```
  </verify>
  <done>Middleware registered globally, non-trailing URLs redirect to trailing versions with 301</done>
</task>

</tasks>

<verification>
1. `/category/marketing` returns 301 redirect to `/category/marketing/`
2. `/category/marketing/` returns 200 (no redirect loop)
3. `/sitemap.xml` returns 200 (no trailing slash added)
4. Query strings preserved: `/tag/seo?page=2` redirects to `/tag/seo/?page=2`
5. POST requests not redirected
</verification>

<success_criteria>
- Middleware enforces trailing slashes via 301 redirect
- File extension paths excluded (sitemap.xml, robots.txt)
- Query strings preserved during redirect
- Only GET requests affected
- No redirect loop on already-trailing URLs
</success_criteria>

<output>
After completion, create `.planning/phases/02-url-preservation-routing/02-06-SUMMARY.md`
</output>
