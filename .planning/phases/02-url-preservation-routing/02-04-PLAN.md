---
phase: 02-url-preservation-routing
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - app/Console/Commands/GenerateSitemap.php
  - routes/console.php
autonomous: true

must_haves:
  truths:
    - "Sitemap.xml is generated with all published posts"
    - "Sitemap includes categories and tags"
    - "Sitemap includes pages"
    - "Sitemap is accessible at /sitemap.xml"
  artifacts:
    - path: "app/Console/Commands/GenerateSitemap.php"
      provides: "Sitemap generation command"
      contains: "Sitemap::create"
    - path: "public/sitemap.xml"
      provides: "Generated sitemap file"
      contains: "urlset"
  key_links:
    - from: "GenerateSitemap command"
      to: "Post, Page, Category, Tag models"
      via: "Eloquent queries"
      pattern: "Post::published"
---

<objective>
Install spatie/laravel-sitemap and create Artisan command to generate sitemap.xml with all content.

Purpose: Sitemap is critical for SEO - search engines use it to discover all URLs. Must include 3,870 posts, 159 pages, 14 categories, 15k tags.
Output: `php artisan sitemap:generate` command that creates public/sitemap.xml
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-url-preservation-routing/02-RESEARCH.md
@app/Models/Post.php
@app/Models/Page.php
@app/Models/Category.php
@app/Models/Tag.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install spatie/laravel-sitemap</name>
  <files>composer.json</files>
  <action>
Install the sitemap package:

```bash
composer require spatie/laravel-sitemap
```

This package:
- Handles sitemap index for large sites (auto-splits at 50k URLs)
- Supports lastmod, changefreq, priority
- Laravel 12 compatible (v7.3.8+)
  </action>
  <verify>
```bash
composer show spatie/laravel-sitemap
```
Should show version 7.3.x installed
  </verify>
  <done>spatie/laravel-sitemap installed via Composer</done>
</task>

<task type="auto">
  <name>Task 2: Create GenerateSitemap Artisan command</name>
  <files>app/Console/Commands/GenerateSitemap.php</files>
  <action>
Create the sitemap generation command:

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Spatie\Sitemap\Sitemap;
use Spatie\Sitemap\Tags\Url;
use App\Models\Post;
use App\Models\Page;
use App\Models\Category;
use App\Models\Tag;

class GenerateSitemap extends Command
{
    protected $signature = 'sitemap:generate';
    protected $description = 'Generate the sitemap.xml file';

    public function handle(): int
    {
        $this->info('Generating sitemap...');

        $sitemap = Sitemap::create();
        $baseUrl = config('app.url');

        // Add homepage
        $sitemap->add(
            Url::create($baseUrl . '/')
                ->setChangeFrequency(Url::CHANGE_FREQUENCY_DAILY)
                ->setPriority(1.0)
        );

        // Add posts (highest priority content)
        $this->info('Adding posts...');
        $postCount = 0;
        Post::published()
            ->select(['slug', 'published_at', 'updated_at'])
            ->orderBy('published_at', 'desc')
            ->chunk(500, function ($posts) use ($sitemap, $baseUrl, &$postCount) {
                foreach ($posts as $post) {
                    $sitemap->add(
                        Url::create($baseUrl . $post->url)
                            ->setLastModificationDate($post->updated_at ?? $post->published_at)
                            ->setChangeFrequency(Url::CHANGE_FREQUENCY_MONTHLY)
                            ->setPriority(0.8)
                    );
                    $postCount++;
                }
            });
        $this->info("  Added {$postCount} posts");

        // Add pages
        $this->info('Adding pages...');
        $pageCount = 0;
        Page::select(['slug', 'updated_at', 'created_at'])
            ->chunk(100, function ($pages) use ($sitemap, $baseUrl, &$pageCount) {
                foreach ($pages as $page) {
                    $sitemap->add(
                        Url::create($baseUrl . $page->url)
                            ->setLastModificationDate($page->updated_at ?? $page->created_at)
                            ->setChangeFrequency(Url::CHANGE_FREQUENCY_YEARLY)
                            ->setPriority(0.6)
                    );
                    $pageCount++;
                }
            });
        $this->info("  Added {$pageCount} pages");

        // Add categories
        $this->info('Adding categories...');
        $categories = Category::select(['slug', 'updated_at'])->get();
        foreach ($categories as $category) {
            $sitemap->add(
                Url::create($baseUrl . $category->url)
                    ->setChangeFrequency(Url::CHANGE_FREQUENCY_WEEKLY)
                    ->setPriority(0.5)
            );
        }
        $this->info("  Added {$categories->count()} categories");

        // Add tags (only those with posts, limit for performance)
        $this->info('Adding tags...');
        $tagCount = 0;
        Tag::select(['slug', 'updated_at'])
            ->whereHas('posts', function ($q) {
                $q->where('status', 'published');
            })
            ->chunk(1000, function ($tags) use ($sitemap, $baseUrl, &$tagCount) {
                foreach ($tags as $tag) {
                    $sitemap->add(
                        Url::create($baseUrl . $tag->url)
                            ->setChangeFrequency(Url::CHANGE_FREQUENCY_WEEKLY)
                            ->setPriority(0.3)
                    );
                    $tagCount++;
                }
            });
        $this->info("  Added {$tagCount} tags with posts");

        // Write sitemap
        $sitemapPath = public_path('sitemap.xml');
        $sitemap->writeToFile($sitemapPath);

        $this->info("Sitemap generated at: {$sitemapPath}");
        $this->info('Total URLs: ' . ($postCount + $pageCount + $categories->count() + $tagCount + 1));

        return Command::SUCCESS;
    }
}
```

**Key implementation details:**
- Uses `chunk()` for memory efficiency with large datasets
- Only includes tags that have published posts (avoids orphan tag pages)
- Sets appropriate priorities: posts (0.8) > pages (0.6) > categories (0.5) > tags (0.3)
- Uses model URL accessors for consistent URLs
  </action>
  <verify>
```bash
php artisan sitemap:generate
ls -la public/sitemap.xml
head -50 public/sitemap.xml
```
Should show command output with counts and valid XML in sitemap.xml
  </verify>
  <done>sitemap:generate command creates public/sitemap.xml with all content types</done>
</task>

<task type="auto">
  <name>Task 3: Add static route for sitemap.xml</name>
  <files>routes/web.php</files>
  <action>
Add a route to serve the sitemap directly (optional but ensures correct content-type):

At the TOP of routes/web.php (before other routes), add:

```php
// Sitemap route - serve static file with correct content-type
Route::get('/sitemap.xml', function () {
    $path = public_path('sitemap.xml');
    if (!file_exists($path)) {
        abort(404, 'Sitemap not generated. Run: php artisan sitemap:generate');
    }
    return response()->file($path, [
        'Content-Type' => 'application/xml',
    ]);
})->name('sitemap');
```

Note: Laravel's public directory also serves static files, but this route ensures proper Content-Type header and a friendly error message.
  </action>
  <verify>
```bash
curl -I http://localhost:8000/sitemap.xml
```
Should return Content-Type: application/xml
  </verify>
  <done>Route serves sitemap.xml with correct Content-Type header</done>
</task>

</tasks>

<verification>
1. `php artisan sitemap:generate` runs without error
2. `public/sitemap.xml` exists and is valid XML
3. Sitemap contains posts with date-based URLs
4. Sitemap contains pages, categories, tags
5. `/sitemap.xml` is accessible via browser/curl
6. Content-Type is application/xml
</verification>

<success_criteria>
- spatie/laravel-sitemap installed
- GenerateSitemap command handles all content types
- Chunking used for memory efficiency
- Only tags with published posts included
- sitemap.xml accessible at /sitemap.xml
</success_criteria>

<output>
After completion, create `.planning/phases/02-url-preservation-routing/02-04-SUMMARY.md`
</output>
