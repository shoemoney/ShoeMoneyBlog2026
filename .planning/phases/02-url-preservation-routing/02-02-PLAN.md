---
phase: 02-url-preservation-routing
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/Http/Controllers/PostController.php
  - app/Http/Controllers/PageController.php
autonomous: true

must_haves:
  truths:
    - "Valid post URL returns the correct post content"
    - "Invalid post URL (wrong date) returns 404"
    - "Valid page slug returns page content"
    - "Invalid page slug returns 404"
  artifacts:
    - path: "app/Http/Controllers/PostController.php"
      provides: "Post lookup with date validation"
      contains: "whereYear"
    - path: "app/Http/Controllers/PageController.php"
      provides: "Page lookup by slug"
      contains: "firstOrFail"
  key_links:
    - from: "PostController"
      to: "Post model"
      via: "Eloquent query"
      pattern: "Post::query"
    - from: "PageController"
      to: "Page model"
      via: "Eloquent query"
      pattern: "Page::where"
---

<objective>
Implement PostController and PageController with proper model lookups and date validation.

Purpose: Posts must validate that the URL date matches published_at to prevent URL manipulation. Pages resolve by slug.
Output: Working controllers that query the database and return actual content (or 404)
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-url-preservation-routing/02-RESEARCH.md
@app/Models/Post.php
@app/Models/Page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PostController with date validation</name>
  <files>app/Http/Controllers/PostController.php</files>
  <action>
Update PostController to query posts with full date validation:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Post;
use Illuminate\Http\Request;

class PostController extends Controller
{
    public function index()
    {
        $posts = Post::published()
            ->with('author', 'categories')
            ->orderBy('published_at', 'desc')
            ->paginate(10);

        // Placeholder view until Phase 3
        return response()->json([
            'message' => 'Homepage - view pending Phase 3',
            'count' => $posts->total(),
        ]);
    }

    public function show(string $year, string $month, string $day, string $slug)
    {
        // Query with full date validation to prevent URL manipulation
        $post = Post::query()
            ->where('slug', $slug)
            ->whereYear('published_at', $year)
            ->whereMonth('published_at', $month)
            ->whereDay('published_at', $day)
            ->where('status', 'published')
            ->with('author', 'categories', 'tags')
            ->firstOrFail();

        // Placeholder response until Phase 3 views
        return response()->json([
            'message' => 'Post found - view pending Phase 3',
            'id' => $post->id,
            'title' => $post->title,
            'url' => $post->url,
            'published_at' => $post->published_at->toIso8601String(),
        ]);
    }
}
```

**Key points:**
- `whereYear`, `whereMonth`, `whereDay` ensure URL date matches actual publish date
- `where('status', 'published')` prevents draft posts from being accessed
- `firstOrFail()` returns 404 if no match
- Eager load relationships to avoid N+1 in future views
  </action>
  <verify>
Test with a known post from the database:
```bash
# Get a sample post
php artisan tinker --execute="echo App\Models\Post::published()->first()?->url ?? 'No posts'"

# Test the URL (will return JSON with post data or 404)
# If posts exist, curl the URL shown above
```
  </verify>
  <done>PostController queries Post model with date validation, returns 404 for invalid dates, 200 with post data for valid URLs</done>
</task>

<task type="auto">
  <name>Task 2: Implement PageController</name>
  <files>app/Http/Controllers/PageController.php</files>
  <action>
Update PageController to query pages by slug:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Page;
use Illuminate\Http\Request;

class PageController extends Controller
{
    public function show(string $slug)
    {
        $page = Page::where('slug', $slug)
            ->with('author')
            ->firstOrFail();

        // Placeholder response until Phase 3 views
        return response()->json([
            'message' => 'Page found - view pending Phase 3',
            'id' => $page->id,
            'title' => $page->title,
            'url' => $page->url,
        ]);
    }
}
```

**Key points:**
- Simple slug lookup with `firstOrFail()` for 404 on missing pages
- Eager load author relationship
  </action>
  <verify>
Test with a known page:
```bash
# Get a sample page
php artisan tinker --execute="echo App\Models\Page::first()?->slug ?? 'No pages'"

# Test the URL (replace 'about' with actual slug)
curl -s http://localhost:8000/about/
```
  </verify>
  <done>PageController queries Page model by slug, returns 404 for invalid slugs, 200 with page data for valid URLs</done>
</task>

</tasks>

<verification>
1. Valid post URL returns 200 with post JSON
2. Invalid post URL (wrong date for existing slug) returns 404
3. Non-existent post slug returns 404
4. Valid page slug returns 200 with page JSON
5. Non-existent page slug returns 404
</verification>

<success_criteria>
- PostController validates year/month/day against published_at
- PostController only shows published posts
- PageController resolves pages by slug
- Both controllers use firstOrFail() for proper 404s
- Relationships eager loaded for performance
</success_criteria>

<output>
After completion, create `.planning/phases/02-url-preservation-routing/02-02-SUMMARY.md`
</output>
