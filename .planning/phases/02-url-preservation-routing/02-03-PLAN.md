---
phase: 02-url-preservation-routing
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/Http/Controllers/CategoryController.php
  - app/Http/Controllers/TagController.php
autonomous: true

must_haves:
  truths:
    - "Valid category slug returns category with posts"
    - "Valid tag slug returns tag with posts"
    - "Invalid category/tag slugs return 404"
  artifacts:
    - path: "app/Http/Controllers/CategoryController.php"
      provides: "Category lookup with posts"
      contains: "firstOrFail"
    - path: "app/Http/Controllers/TagController.php"
      provides: "Tag lookup with posts"
      contains: "firstOrFail"
  key_links:
    - from: "CategoryController"
      to: "Category model"
      via: "Eloquent query"
      pattern: "Category::where"
    - from: "TagController"
      to: "Tag model"
      via: "Eloquent query"
      pattern: "Tag::where"
---

<objective>
Implement CategoryController and TagController with proper model lookups and post relationships.

Purpose: Category and tag archive pages are heavily indexed. URLs like /category/marketing/ must work exactly as in WordPress.
Output: Working controllers that query taxonomy models and return posts
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-url-preservation-routing/02-RESEARCH.md
@app/Models/Category.php
@app/Models/Tag.php
@app/Models/Post.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CategoryController</name>
  <files>app/Http/Controllers/CategoryController.php</files>
  <action>
Update CategoryController to query categories and their posts:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Category;
use App\Models\Post;
use Illuminate\Http\Request;

class CategoryController extends Controller
{
    public function show(string $slug)
    {
        $category = Category::where('slug', $slug)->firstOrFail();

        // Get published posts in this category
        $posts = $category->posts()
            ->where('status', 'published')
            ->whereNotNull('published_at')
            ->with('author')
            ->orderBy('published_at', 'desc')
            ->paginate(10);

        // Placeholder response until Phase 3 views
        return response()->json([
            'message' => 'Category archive - view pending Phase 3',
            'category' => [
                'id' => $category->id,
                'name' => $category->name,
                'slug' => $category->slug,
                'url' => $category->url,
            ],
            'posts_count' => $posts->total(),
            'posts' => $posts->map(fn($p) => [
                'title' => $p->title,
                'url' => $p->url,
            ]),
        ]);
    }
}
```

**Key points:**
- Lookup category by slug with `firstOrFail()` for 404
- Filter posts to only published ones
- Paginate results for performance with 15k+ tags potentially
  </action>
  <verify>
Test with a known category:
```bash
# Get a sample category
php artisan tinker --execute="echo App\Models\Category::first()?->slug ?? 'No categories'"

# Test the URL
curl -s http://localhost:8000/category/marketing/ | jq .
```
  </verify>
  <done>CategoryController queries Category by slug, returns 404 for invalid, returns category + paginated posts for valid</done>
</task>

<task type="auto">
  <name>Task 2: Implement TagController</name>
  <files>app/Http/Controllers/TagController.php</files>
  <action>
Update TagController to query tags and their posts:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Tag;
use App\Models\Post;
use Illuminate\Http\Request;

class TagController extends Controller
{
    public function show(string $slug)
    {
        $tag = Tag::where('slug', $slug)->firstOrFail();

        // Get published posts with this tag
        $posts = $tag->posts()
            ->where('status', 'published')
            ->whereNotNull('published_at')
            ->with('author')
            ->orderBy('published_at', 'desc')
            ->paginate(10);

        // Placeholder response until Phase 3 views
        return response()->json([
            'message' => 'Tag archive - view pending Phase 3',
            'tag' => [
                'id' => $tag->id,
                'name' => $tag->name,
                'slug' => $tag->slug,
                'url' => $tag->url,
            ],
            'posts_count' => $posts->total(),
            'posts' => $posts->map(fn($p) => [
                'title' => $p->title,
                'url' => $p->url,
            ]),
        ]);
    }
}
```

**Key points:**
- Same pattern as CategoryController
- With 15,448 tags, pagination is essential
- Only show published posts
  </action>
  <verify>
Test with a known tag:
```bash
# Get a sample tag
php artisan tinker --execute="echo App\Models\Tag::first()?->slug ?? 'No tags'"

# Test the URL
curl -s http://localhost:8000/tag/seo/ | jq .
```
  </verify>
  <done>TagController queries Tag by slug, returns 404 for invalid, returns tag + paginated posts for valid</done>
</task>

</tasks>

<verification>
1. Valid category slug returns 200 with category data and posts
2. Invalid category slug returns 404
3. Valid tag slug returns 200 with tag data and posts
4. Invalid tag slug returns 404
5. Posts in archives are only published ones
</verification>

<success_criteria>
- CategoryController resolves by slug with firstOrFail()
- TagController resolves by slug with firstOrFail()
- Both filter to only published posts
- Both paginate results (important for 15k tags)
- Relationships eager loaded
</success_criteria>

<output>
After completion, create `.planning/phases/02-url-preservation-routing/02-03-SUMMARY.md`
</output>
