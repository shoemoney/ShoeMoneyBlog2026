---
phase: 07-performance-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - config/backup.php
  - config/filesystems.php
  - routes/console.php
autonomous: true
user_setup:
  - service: aws-s3
    why: "External backup storage"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "AWS IAM Console -> Users -> Security credentials"
      - name: AWS_SECRET_ACCESS_KEY
        source: "AWS IAM Console -> Users -> Security credentials"
      - name: AWS_DEFAULT_REGION
        source: "AWS S3 Console -> Bucket region (e.g., us-east-1)"
      - name: AWS_BACKUP_BUCKET
        source: "AWS S3 Console -> Create bucket -> Bucket name"
    dashboard_config:
      - task: "Create S3 bucket for backups"
        location: "AWS S3 Console -> Create bucket"
      - task: "Create IAM user with S3 access policy"
        location: "AWS IAM Console -> Users -> Add user"

must_haves:
  truths:
    - "Backup command runs and creates backup archive"
    - "Backup is stored on configured S3 disk"
    - "Daily backup is scheduled at 01:30"
    - "Daily cleanup is scheduled at 01:00"
  artifacts:
    - path: "config/backup.php"
      provides: "Backup configuration with S3 disk"
      contains: "destination"
    - path: "config/filesystems.php"
      provides: "S3 backup disk configuration"
      contains: "backups"
    - path: "routes/console.php"
      provides: "Backup scheduling"
      contains: "backup:run"
  key_links:
    - from: "routes/console.php"
      to: "backup:run command"
      via: "Schedule facade"
      pattern: "Schedule::command.*backup:run"
    - from: "config/backup.php"
      to: "config/filesystems.php"
      via: "destination disk reference"
      pattern: "disks.*backups"
---

<objective>
Install and configure spatie/laravel-backup for automated daily backups to S3 external storage.

Purpose: Protect 20 years of blog content with automated daily backups stored externally. Backups run at 01:00 (cleanup) and 01:30 (new backup) to avoid DST transition issues.

Output: Working backup system that creates daily database + files archives and stores them on S3.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-performance-polish/07-RESEARCH.md

@config/filesystems.php
@routes/console.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install backup package and configure S3 disk</name>
  <files>
    config/backup.php
    config/filesystems.php
  </files>
  <action>
1. Install spatie/laravel-backup:
   ```bash
   composer require spatie/laravel-backup
   ```

2. Publish the backup config:
   ```bash
   php artisan vendor:publish --provider="Spatie\Backup\BackupServiceProvider"
   ```

3. Add S3 backup disk to config/filesystems.php in the 'disks' array (after 's3'):
   ```php
   'backups' => [
       'driver' => 's3',
       'key' => env('AWS_ACCESS_KEY_ID'),
       'secret' => env('AWS_SECRET_ACCESS_KEY'),
       'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
       'bucket' => env('AWS_BACKUP_BUCKET'),
       'visibility' => 'private',
       'throw' => false,
       'report' => false,
   ],
   ```

4. Update config/backup.php to use the backups disk.
   Find the 'destination' section and update 'disks':
   ```php
   'destination' => [
       'filename_prefix' => 'shoemoney-',
       'disks' => [
           'backups',
       ],
   ],
   ```

5. Also update the 'backup' source section to include the database:
   The default config should already include 'databases' => ['mysql'] - verify this is correct.

6. Configure cleanup strategy in config/backup.php under 'cleanup' -> 'default_strategy':
   ```php
   'keep_all_backups_for_days' => 7,
   'keep_daily_backups_for_days' => 30,
   'keep_weekly_backups_for_weeks' => 8,
   'keep_monthly_backups_for_months' => 4,
   'keep_yearly_backups_for_years' => 2,
   ```

Note: The package also supports local disk for development. We configure S3 for production but can test locally.
  </action>
  <verify>
Run `php artisan config:show backup` to verify backup config is published.
Check that config/filesystems.php contains 'backups' disk.
Check that config/backup.php destination.disks includes 'backups'.
  </verify>
  <done>
Backup package installed with S3 disk configuration. Backup archives will be stored on S3 with configured retention policy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Schedule daily backups</name>
  <files>
    routes/console.php
  </files>
  <action>
1. Update routes/console.php to add backup scheduling:

```php
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Schedule;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');

/*
|--------------------------------------------------------------------------
| Scheduled Backups
|--------------------------------------------------------------------------
|
| Backups run at 01:00 (cleanup) and 01:30 (new backup).
| Times chosen to avoid DST transition hours (02:00-03:00).
| Cleanup runs first to ensure space for new backup.
|
*/

Schedule::command('backup:clean')->daily()->at('01:00');
Schedule::command('backup:run')->daily()->at('01:30');
```

Note: For the scheduler to run, production server needs cron entry:
```
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```
This is a deployment concern, not something we configure in code.
  </action>
  <verify>
Run `php artisan schedule:list` to confirm backup commands are scheduled.
Should show backup:clean at 01:00 and backup:run at 01:30.
  </verify>
  <done>
Backup schedule configured: cleanup at 01:00, new backup at 01:30 daily.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test backup locally (dry run)</name>
  <files></files>
  <action>
1. First, test that backup command runs without errors (will use local disk if S3 not configured):
   ```bash
   php artisan backup:run --only-db
   ```
   This creates a database-only backup to verify the command works.

2. Check backup was created:
   ```bash
   php artisan backup:list
   ```
   Should show the backup with size and date.

3. If S3 credentials are not yet configured, the backup will fail to upload.
   For now, modify config/backup.php temporarily to use 'local' disk for testing:
   ```php
   'disks' => [
       'local', // Use 'backups' in production with S3 credentials
   ],
   ```
   Then run again:
   ```bash
   php artisan backup:run --only-db
   php artisan backup:list
   ```

4. Verify backup exists in storage/app/shoemoney-*:
   ```bash
   ls -la storage/app/shoemoney-*/
   ```

5. Revert to 'backups' disk in config for production use.

Note: Full production testing requires S3 credentials (see user_setup in frontmatter).
For now, we verify the backup system works with local disk.
  </action>
  <verify>
`php artisan backup:run --only-db` completes without error.
`php artisan backup:list` shows the created backup.
Backup file exists in storage/app/ directory.
  </verify>
  <done>
Backup system tested locally. Database backup creates successfully. S3 upload requires AWS credentials (documented in user_setup).
  </done>
</task>

</tasks>

<verification>
- [ ] `composer show spatie/laravel-backup` shows package installed
- [ ] `config/backup.php` exists with destination.disks configured
- [ ] `config/filesystems.php` contains 'backups' disk with S3 driver
- [ ] `routes/console.php` contains Schedule::command for backup:clean and backup:run
- [ ] `php artisan schedule:list` shows backup commands at 01:00 and 01:30
- [ ] `php artisan backup:run --only-db` completes successfully
- [ ] `php artisan backup:list` shows created backup
</verification>

<success_criteria>
- Backup package installed and configured for S3 storage
- Daily backup schedule: cleanup at 01:00, backup at 01:30
- Backup command successfully creates database archive
- Retention policy: 7 days all, 30 days daily, 8 weeks weekly, 4 months monthly, 2 years yearly
- Production deployment requires AWS credentials (documented for user setup)
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-polish/07-04-SUMMARY.md`
</output>
