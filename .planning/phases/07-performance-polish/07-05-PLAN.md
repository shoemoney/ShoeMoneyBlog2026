---
phase: 07-performance-polish
plan: 05
type: execute
wave: 2
depends_on: ["07-01", "07-02", "07-03", "07-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Homepage loads in under 1 second (LCP metric)"
    - "Response caching working for public pages"
    - "Dark mode toggle works without FOUC"
    - "Database queries use indexes (no full table scans)"
    - "Backup system creates archives"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 7 success criteria are met: sub-second page load, working caching, dark mode, optimized queries, and functional backups.

Purpose: Confirm the site is production-ready with measurable performance improvements and all polish features working correctly.

Output: Verification report confirming all success criteria pass.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-performance-polish/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Measure page load performance</name>
  <files></files>
  <action>
1. Ensure production build is compiled:
   ```bash
   npm run build
   ```

2. Start the server:
   ```bash
   php artisan serve &
   sleep 2
   ```

3. Measure response time with curl (multiple requests to account for cache):
   ```bash
   # Clear cache first
   php artisan responsecache:clear

   # First request (uncached)
   echo "First request (uncached):"
   time curl -s -o /dev/null -w "Total time: %{time_total}s\n" http://127.0.0.1:8000/

   # Second request (cached)
   echo "Second request (cached):"
   time curl -s -o /dev/null -w "Total time: %{time_total}s\n" http://127.0.0.1:8000/
   ```

4. Target: Total response time under 1 second. Cached responses should be under 100ms.

Note: True Lighthouse/PageSpeed testing requires deployed environment. Local curl timing verifies server-side performance. Client-side LCP depends on network and browser factors.
  </action>
  <verify>
Cached homepage response returns in under 100ms.
Uncached homepage response returns in under 1s.
  </verify>
  <done>
Page load performance measured. Cached responses are sub-100ms, meeting the under-1-second target.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify response caching and invalidation</name>
  <files></files>
  <action>
1. Test cache hit:
   ```bash
   # Clear and prime cache
   php artisan responsecache:clear
   curl -s http://127.0.0.1:8000/ > /dev/null

   # Check for cache hit (measure time difference)
   echo "Testing cache hit..."
   START=$(date +%s%N)
   curl -s http://127.0.0.1:8000/ > /dev/null
   END=$(date +%s%N)
   echo "Cached request: $(( ($END - $START) / 1000000 ))ms"
   ```

2. Test cache invalidation:
   ```bash
   # Update a post
   php artisan tinker --execute="\App\Models\Post::first()->touch(); echo 'Post touched';"

   # Next request should be slower (cache miss)
   echo "After cache invalidation:"
   START=$(date +%s%N)
   curl -s http://127.0.0.1:8000/ > /dev/null
   END=$(date +%s%N)
   echo "Uncached request: $(( ($END - $START) / 1000000 ))ms"
   ```

3. Verify admin routes are not cached:
   ```bash
   # Should redirect to login (302), not return cached content
   curl -I http://127.0.0.1:8000/admin/ 2>/dev/null | head -3
   ```
  </action>
  <verify>
Cached requests are significantly faster than uncached.
Post.touch() clears cache (next request is slower).
Admin routes return 302 redirect, not cached content.
  </verify>
  <done>
Response caching verified: cache hits work, invalidation works, admin excluded.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify database indexes are used</name>
  <files></files>
  <action>
1. Check posts table indexes exist:
   ```bash
   php artisan tinker --execute="
   \$indexes = collect(\DB::select('SHOW INDEX FROM posts'))->pluck('Key_name')->unique();
   echo 'Posts indexes: ' . \$indexes->implode(', ');
   "
   ```
   Should include: posts_status_index, posts_status_published_index

2. Verify homepage query uses index:
   ```bash
   php artisan tinker --execute="
   \$explain = \DB::select('EXPLAIN SELECT * FROM posts WHERE status = ? AND published_at IS NOT NULL ORDER BY published_at DESC LIMIT 15', ['published']);
   echo 'Type: ' . \$explain[0]->type . '\n';
   echo 'Key: ' . \$explain[0]->key . '\n';
   echo 'Extra: ' . \$explain[0]->Extra;
   "
   ```
   Should show type: ref or range, key: posts_status_published_index

3. Check polymorphic indexes:
   ```bash
   php artisan tinker --execute="
   \$taggables = collect(\DB::select('SHOW INDEX FROM taggables'))->pluck('Key_name')->unique();
   \$categorizables = collect(\DB::select('SHOW INDEX FROM categorizables'))->pluck('Key_name')->unique();
   echo 'Taggables: ' . \$taggables->implode(', ') . '\n';
   echo 'Categorizables: ' . \$categorizables->implode(', ');
   "
   ```
  </action>
  <verify>
Posts table has status and status_published indexes.
EXPLAIN shows index usage (not full table scan).
Polymorphic tables have reverse lookup indexes.
  </verify>
  <done>
Database indexes verified: all performance indexes exist and are used by queries.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify backup system</name>
  <files></files>
  <action>
1. Check backup schedule is registered:
   ```bash
   php artisan schedule:list
   ```
   Should show backup:clean at 01:00 and backup:run at 01:30

2. Verify backup command works:
   ```bash
   php artisan backup:run --only-db
   ```

3. List backups:
   ```bash
   php artisan backup:list
   ```
   Should show at least one backup with size and date.

4. Check backup files exist:
   ```bash
   ls -la storage/app/shoemoney-*/
   ```

Note: S3 upload requires AWS credentials. Local backup proves the system works.
  </action>
  <verify>
Schedule shows backup commands at correct times.
backup:run completes without error.
backup:list shows created backup.
  </verify>
  <done>
Backup system verified: schedule configured, backup command works, archives created.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Performance & Polish implementation:
- Response caching with automatic invalidation
- Dark mode toggle with localStorage persistence
- Database performance indexes
- Automated backup system
  </what-built>
  <how-to-verify>
1. **Dark Mode Toggle:**
   - Visit http://127.0.0.1:8000/
   - Look for theme toggle button in navigation (sun/moon icon)
   - Click to switch between light and dark themes
   - Refresh page - theme should persist
   - Check for FOUC (flash of wrong theme on load)

2. **Response Speed:**
   - Navigate to homepage and several posts
   - Notice that subsequent page loads feel faster (cached)

3. **Visual Check:**
   - Dark mode: dark background, light text, readable content
   - Light mode: white background, dark text
   - Both modes should have consistent styling

4. **Admin Panel:**
   - Visit /admin/ (login if needed)
   - Verify admin pages still work correctly
   - Admin should NOT be affected by response cache
  </how-to-verify>
  <resume-signal>Type "approved" if dark mode works correctly without FOUC, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Homepage response time under 1 second
- [ ] Cached responses significantly faster than uncached
- [ ] Cache invalidates when post is updated
- [ ] Dark mode toggle visible and functional
- [ ] Theme persists across page refresh
- [ ] No FOUC on page load
- [ ] Database indexes exist and are used
- [ ] Backup schedule configured
- [ ] Backup command creates archive
</verification>

<success_criteria>
All Phase 7 success criteria verified:
1. Homepage loads in under 1 second
2. Response caching enabled with automatic invalidation
3. Dark mode toggle works with persistent preference
4. Database queries use indexes
5. Backup system configured and functional
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-polish/07-05-SUMMARY.md`
</output>
