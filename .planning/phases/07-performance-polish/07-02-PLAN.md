---
phase: 07-performance-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - resources/css/app.css
  - resources/views/components/layout.blade.php
  - resources/views/components/theme-toggle.blade.php
  - resources/views/components/navigation.blade.php
autonomous: true

must_haves:
  truths:
    - "User can click a toggle button to switch between light and dark themes"
    - "Theme preference persists across page refreshes via localStorage"
    - "No flash of wrong theme on page load (FOUC prevention)"
    - "System preference (prefers-color-scheme) is respected as default"
  artifacts:
    - path: "resources/css/app.css"
      provides: "Dark mode variant definition"
      contains: "@custom-variant dark"
    - path: "resources/views/components/layout.blade.php"
      provides: "FOUC prevention script and Alpine.js dark mode binding"
      contains: "localStorage.theme"
    - path: "resources/views/components/theme-toggle.blade.php"
      provides: "Theme toggle button component"
      min_lines: 15
  key_links:
    - from: "layout.blade.php"
      to: "theme-toggle.blade.php"
      via: "x-theme-toggle component"
      pattern: "<x-theme-toggle"
    - from: "theme-toggle.blade.php"
      to: "localStorage"
      via: "Alpine.js click handler"
      pattern: "localStorage.setItem"
---

<objective>
Implement dark mode with Tailwind CSS v4's @custom-variant, Alpine.js localStorage persistence, and FOUC prevention.

Purpose: Allow users to toggle between light and dark themes with their preference remembered across sessions. Respects system preference (prefers-color-scheme) as default.

Output: Working dark mode toggle in navigation that switches theme instantly and persists via localStorage.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-performance-polish/07-RESEARCH.md

@resources/css/app.css
@resources/views/components/layout.blade.php
@resources/views/components/navigation.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark mode CSS variant and dark theme styles</name>
  <files>
    resources/css/app.css
  </files>
  <action>
1. Add Tailwind v4 dark mode custom variant to resources/css/app.css.
   Add this line AFTER the @import 'tailwindcss'; line:
   ```css
   @custom-variant dark (&:where(.dark, .dark *));
   ```

2. Add dark mode brand colors to the @theme block:
   ```css
   @theme {
       --font-sans: 'Instrument Sans', ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
           'Segoe UI Symbol', 'Noto Color Emoji';

       /* ShoeMoney Brand Colors - Light Mode */
       --color-brand-primary: #1e40af;
       --color-brand-accent: #f59e0b;
       --color-brand-light: #f8fafc;

       /* Dark Mode Colors */
       --color-dark-bg: #0f172a;
       --color-dark-surface: #1e293b;
       --color-dark-text: #f1f5f9;
   }
   ```

3. Add dark mode overrides for WordPress content styles:
   ```css
   /* Dark mode for WordPress content */
   .dark .wp-caption figcaption {
       @apply text-gray-400;
   }

   .dark .wp-more {
       @apply bg-gray-700;
   }
   ```

The @custom-variant directive tells Tailwind that dark: classes should apply when .dark class is on an ancestor element (class-based dark mode strategy).
  </action>
  <verify>
Run `npm run build` or `npm run dev` to ensure CSS compiles without errors.
Check that app.css contains @custom-variant dark line.
  </verify>
  <done>
Dark mode variant configured in Tailwind CSS v4. Dark: prefix classes will now work when .dark is on html element.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FOUC prevention and Alpine.js dark mode to layout</name>
  <files>
    resources/views/components/layout.blade.php
  </files>
  <action>
1. Update resources/views/components/layout.blade.php to add:
   - Inline FOUC prevention script in <head> BEFORE any CSS
   - Alpine.js x-data on <html> element for reactivity
   - Dark mode body styles

Replace the entire file with:
```blade
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}"
      x-data="{ darkMode: localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
      x-init="$watch('darkMode', val => localStorage.setItem('theme', val ? 'dark' : 'light'))"
      :class="{ 'dark': darkMode }">
<head>
    {{-- FOUC prevention: Set dark class BEFORE CSS loads --}}
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <x-seo::meta />

    @vite(['resources/css/app.css', 'resources/js/app.js'])

    @livewireStyles
</head>
<body class="bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100 antialiased min-h-screen flex flex-col transition-colors duration-200">
    <x-navigation />

    <main class="flex-1 container mx-auto px-4 py-8">
        {{ $slot }}
    </main>

    <x-footer />

    @livewireScripts
</body>
</html>
```

Key points:
- FOUC script runs synchronously before CSS, setting .dark class immediately
- Alpine.js x-data tracks darkMode state, syncs to localStorage on change
- Body has dark: variants for background and text colors
- transition-colors adds smooth color transitions
  </action>
  <verify>
Check that layout.blade.php contains inline script in head before @vite.
Check that html element has x-data and :class bindings.
Check that body has dark: variant classes.
  </verify>
  <done>
FOUC prevention script and Alpine.js dark mode binding added to layout. Dark mode state is reactive and persisted.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create theme toggle component and add to navigation</name>
  <files>
    resources/views/components/theme-toggle.blade.php
    resources/views/components/navigation.blade.php
  </files>
  <action>
1. Create resources/views/components/theme-toggle.blade.php:
```blade
{{-- Theme Toggle Button --}}
{{-- Uses Alpine.js darkMode state from parent layout --}}
<button
    @click="darkMode = !darkMode"
    type="button"
    class="p-2 rounded-lg bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"
    :aria-label="darkMode ? 'Switch to light mode' : 'Switch to dark mode'"
    :title="darkMode ? 'Switch to light mode' : 'Switch to dark mode'"
>
    {{-- Sun icon (shown in dark mode) --}}
    <svg x-show="darkMode" x-cloak class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
    </svg>
    {{-- Moon icon (shown in light mode) --}}
    <svg x-show="!darkMode" x-cloak class="w-5 h-5 text-slate-700" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
    </svg>
</button>
```

2. Read current navigation.blade.php to understand its structure, then add x-theme-toggle to the nav links area. The toggle should be placed in the navigation alongside other nav elements.

Update resources/views/components/navigation.blade.php to include the theme toggle button. Add it after the nav links, before the closing nav tag:
```blade
<x-theme-toggle />
```

3. Add x-cloak style to hide elements before Alpine initializes. This should be in the layout's head or app.css:
In resources/css/app.css, add at the end:
```css
/* Alpine.js cloak - hide until Alpine initializes */
[x-cloak] {
    display: none !important;
}
```
  </action>
  <verify>
Check that theme-toggle.blade.php exists with sun/moon icons.
Check that navigation.blade.php includes x-theme-toggle component.
Check that app.css includes [x-cloak] style.
Visit site and confirm toggle button appears in navigation.
  </verify>
  <done>
Theme toggle component created with sun/moon icons and added to navigation. Users can click to switch themes.
  </done>
</task>

</tasks>

<verification>
- [ ] `resources/css/app.css` contains `@custom-variant dark`
- [ ] `resources/views/components/layout.blade.php` has FOUC prevention script before @vite
- [ ] `resources/views/components/layout.blade.php` has Alpine.js x-data on html element
- [ ] `resources/views/components/theme-toggle.blade.php` exists with sun/moon icons
- [ ] `resources/views/components/navigation.blade.php` includes x-theme-toggle
- [ ] `resources/css/app.css` contains [x-cloak] style
- [ ] `npm run build` completes without errors
</verification>

<success_criteria>
- Theme toggle button visible in navigation bar
- Clicking toggle switches between light and dark themes instantly
- Theme preference persists in localStorage across page refreshes
- No flash of wrong theme color on page load (FOUC prevented)
- System preference (prefers-color-scheme) respected when no localStorage value
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-polish/07-02-SUMMARY.md`
</output>
