---
phase: 07-performance-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bootstrap/app.php
  - config/responsecache.php
  - app/Traits/ClearsResponseCache.php
  - app/Models/Post.php
  - app/Models/Comment.php
autonomous: true

must_haves:
  truths:
    - "Public pages served from cache on second request"
    - "Cache automatically clears when post is updated"
    - "Cache automatically clears when comment is approved"
    - "Admin routes are never cached"
  artifacts:
    - path: "config/responsecache.php"
      provides: "Response cache configuration"
      contains: "cache_profile"
    - path: "app/Traits/ClearsResponseCache.php"
      provides: "Cache invalidation trait for models"
      min_lines: 15
    - path: "bootstrap/app.php"
      provides: "Response cache middleware registration"
      contains: "CacheResponse"
  key_links:
    - from: "app/Models/Post.php"
      to: "ResponseCache::clear()"
      via: "ClearsResponseCache trait"
      pattern: "use.*ClearsResponseCache"
    - from: "bootstrap/app.php"
      to: "CacheResponse middleware"
      via: "web middleware append"
      pattern: "CacheResponse::class"
---

<objective>
Install and configure spatie/laravel-responsecache for HTTP response caching with automatic invalidation when content changes.

Purpose: Reduce server response time by serving cached HTML responses for public pages (homepage, posts, categories, tags). Cache clears automatically when Post or Comment models change.

Output: Working response cache that serves cached pages for anonymous visitors while bypassing cache for authenticated users and admin routes.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-performance-polish/07-RESEARCH.md

@bootstrap/app.php
@app/Models/Post.php
@app/Models/Comment.php
@routes/web.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure response cache package</name>
  <files>
    config/responsecache.php
    bootstrap/app.php
  </files>
  <action>
1. Install spatie/laravel-responsecache:
   ```bash
   composer require spatie/laravel-responsecache
   ```

2. Publish the config file:
   ```bash
   php artisan vendor:publish --provider="Spatie\ResponseCache\ResponseCacheServiceProvider"
   ```

3. Update bootstrap/app.php to add response cache middleware to web stack AND register doNotCacheResponse alias:
   ```php
   ->withMiddleware(function (Middleware $middleware): void {
       $middleware->prepend(TrailingSlashRedirect::class);

       // Add response caching for public pages
       $middleware->web(append: [
           \Spatie\ResponseCache\Middlewares\CacheResponse::class,
       ]);

       // Register doNotCacheResponse alias for routes that should skip caching
       $middleware->alias([
           'doNotCacheResponse' => \Spatie\ResponseCache\Middlewares\DoNotCacheResponse::class,
       ]);
   })
   ```

4. Update routes/web.php to add doNotCacheResponse middleware to admin routes:
   ```php
   Route::prefix('admin')
       ->middleware(['auth', EnsureUserIsAdmin::class, 'doNotCacheResponse'])
       ->group(function () {
   ```

Note: The default CacheProfile (CacheAllSuccessfulGetRequests) automatically skips authenticated users, so only anonymous visitors get cached responses.
  </action>
  <verify>
Run `php artisan config:show responsecache` to confirm config is published.
Check that bootstrap/app.php contains both CacheResponse middleware and doNotCacheResponse alias.
  </verify>
  <done>
Response cache package installed, middleware registered in web stack, and admin routes excluded from caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cache invalidation trait and wire to models</name>
  <files>
    app/Traits/ClearsResponseCache.php
    app/Models/Post.php
    app/Models/Comment.php
  </files>
  <action>
1. Create app/Traits/ClearsResponseCache.php:
   ```php
   <?php

   namespace App\Traits;

   use Spatie\ResponseCache\Facades\ResponseCache;

   trait ClearsResponseCache
   {
       public static function bootClearsResponseCache(): void
       {
           static::saved(fn() => ResponseCache::clear());
           static::deleted(fn() => ResponseCache::clear());
       }
   }
   ```

2. Add the trait to app/Models/Post.php:
   - Import: `use App\Traits\ClearsResponseCache;`
   - Add to class: `use ClearsResponseCache;` (after existing traits)

3. Add the trait to app/Models/Comment.php:
   - Import: `use App\Traits\ClearsResponseCache;`
   - Add to class: `use ClearsResponseCache;` (after existing traits)

This ensures cache clears when:
- Post is created, updated, or deleted
- Comment is created, approved, rejected, or deleted

Note: Using full cache clear instead of tag-based invalidation (simpler, and with 3,870 posts the cache rebuild is fast).
  </action>
  <verify>
Run `grep -r "ClearsResponseCache" app/Models/` to confirm both models use the trait.
Run `php artisan tinker --execute="echo class_uses(\App\Models\Post::class)['App\Traits\ClearsResponseCache'] ?? 'MISSING';"` to verify trait is loaded.
  </verify>
  <done>
ClearsResponseCache trait created and wired to Post and Comment models. Any save/delete on these models clears the entire response cache.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify caching works end-to-end</name>
  <files></files>
  <action>
1. Clear any existing cache:
   ```bash
   php artisan responsecache:clear
   ```

2. Start the dev server if not running:
   ```bash
   php artisan serve &
   ```

3. Test caching with curl (two requests to same URL should show cache hit):
   ```bash
   # First request - cache MISS (no X-Cache-Response header or "MISS")
   curl -I http://127.0.0.1:8000/ 2>/dev/null | grep -i cache

   # Second request - cache HIT
   curl -I http://127.0.0.1:8000/ 2>/dev/null | grep -i cache
   ```

4. Verify cache invalidation works:
   ```bash
   # Update a post in tinker
   php artisan tinker --execute="\App\Models\Post::first()->touch();"

   # Next request should be a cache MISS again
   curl -I http://127.0.0.1:8000/ 2>/dev/null | grep -i cache
   ```

5. Verify admin routes are NOT cached:
   ```bash
   # Login required, but should see doNotCacheResponse in effect
   curl -I http://127.0.0.1:8000/admin/ 2>/dev/null | head -5
   ```
  </action>
  <verify>
Second request to homepage returns cached response (confirmed via response headers or timing).
Updating a post clears cache (next request is fresh).
Admin routes redirect to login (not cached).
  </verify>
  <done>
Response caching verified: public pages cached, cache invalidates on model changes, admin routes excluded.
  </done>
</task>

</tasks>

<verification>
- [ ] `composer show spatie/laravel-responsecache` shows package installed
- [ ] `config/responsecache.php` exists with default configuration
- [ ] `bootstrap/app.php` contains CacheResponse middleware and doNotCacheResponse alias
- [ ] `app/Traits/ClearsResponseCache.php` exists
- [ ] Post and Comment models include ClearsResponseCache trait
- [ ] Homepage returns cached response on second request
- [ ] Cache clears when post is updated
</verification>

<success_criteria>
- Public pages (homepage, posts, categories, tags) are served from cache on repeat visits
- Cache automatically invalidates when Post or Comment models are saved/deleted
- Admin routes are never cached (doNotCacheResponse middleware applied)
- Authenticated users always get fresh responses (default cache profile behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-polish/07-01-SUMMARY.md`
</output>
