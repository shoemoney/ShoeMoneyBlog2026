---
phase: 05-search-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - config/scout.php
  - .env
  - app/Models/Post.php
autonomous: true
user_setup:
  - service: algolia
    why: "Search backend for typeahead functionality"
    env_vars:
      - name: ALGOLIA_APP_ID
        source: "Algolia Dashboard -> Settings -> API Keys -> Application ID"
      - name: ALGOLIA_SECRET
        source: "Algolia Dashboard -> Settings -> API Keys -> Admin API Key"

must_haves:
  truths:
    - "Scout Extended package is installed and configured"
    - "Post model has Searchable trait with proper configuration"
    - "Only published posts will be indexed"
  artifacts:
    - path: "config/scout.php"
      provides: "Scout configuration with Algolia driver"
      contains: "algolia"
    - path: "app/Models/Post.php"
      provides: "Searchable model for indexing"
      contains: "Searchable"
  key_links:
    - from: "config/scout.php"
      to: ".env"
      via: "env() function calls"
      pattern: "env\\('ALGOLIA"
    - from: "app/Models/Post.php"
      to: "Laravel\\Scout\\Searchable"
      via: "use trait"
      pattern: "use Searchable"
---

<objective>
Install Laravel Scout Extended with Algolia driver and configure Post model for search indexing.

Purpose: Establish the search infrastructure that enables typeahead functionality across ~3,870 published posts.
Output: Scout configured, Post model searchable, ready for index import.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-search-integration/05-RESEARCH.md
@app/Models/Post.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Scout Extended and publish configuration</name>
  <files>composer.json, composer.lock, config/scout.php</files>
  <action>
Install algolia/scout-extended package:

```bash
composer require "algolia/scout-extended:^3.0"
php artisan vendor:publish --provider="Laravel\Scout\ScoutServiceProvider"
```

After publishing, update `config/scout.php` with these settings:

```php
return [
    'driver' => env('SCOUT_DRIVER', 'algolia'),
    'prefix' => env('SCOUT_PREFIX', ''),
    'queue' => env('SCOUT_QUEUE', false),  // false for dev, true for production
    'after_commit' => true,
    'chunk' => [
        'searchable' => 500,
        'unsearchable' => 500,
    ],
    'soft_delete' => false,
    'identify' => env('SCOUT_IDENTIFY', false),

    'algolia' => [
        'id' => env('ALGOLIA_APP_ID', ''),
        'secret' => env('ALGOLIA_SECRET', ''),
    ],
];
```

Add placeholder env vars to .env:

```
SCOUT_DRIVER=algolia
SCOUT_PREFIX=shoemoney_
SCOUT_QUEUE=false
ALGOLIA_APP_ID=
ALGOLIA_SECRET=
```
  </action>
  <verify>
Run `php artisan config:clear && php artisan config:show scout` and confirm algolia driver is set.
File `config/scout.php` exists with algolia configuration.
  </verify>
  <done>
Scout Extended installed, config published, env vars added to .env.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Searchable trait to Post model</name>
  <files>app/Models/Post.php</files>
  <action>
Update Post model to add Laravel Scout Searchable trait with proper configuration.

Add `use Laravel\Scout\Searchable;` import.

Add `use Searchable;` trait to the class.

Add these three methods:

1. `toSearchableArray()` - Define indexed fields:
```php
public function toSearchableArray(): array
{
    return [
        'id' => $this->id,
        'title' => $this->title,
        'excerpt' => $this->excerpt,
        'content' => \Illuminate\Support\Str::limit(strip_tags($this->content ?? ''), 5000),
        'slug' => $this->slug,
        'published_at' => $this->published_at?->timestamp,
    ];
}
```

2. `shouldBeSearchable()` - Only index published posts:
```php
public function shouldBeSearchable(): bool
{
    return $this->status === 'published' && $this->published_at !== null;
}
```

3. `searchableAs()` - Use prefixed index name:
```php
public function searchableAs(): string
{
    return config('scout.prefix') . 'posts';
}
```

**Important:** Keep all existing code (relationships, scopes, accessors). Only ADD the trait and these three methods.

Content is truncated to 5000 chars after stripping tags to stay well under Algolia's 10KB limit.
  </action>
  <verify>
Run `php artisan tinker --execute="echo App\\Models\\Post::first()->toSearchableArray()['title'];"` and confirm it outputs a post title.
Run `php artisan tinker --execute="echo App\\Models\\Post::first()->searchableAs();"` and confirm it outputs "shoemoney_posts".
  </verify>
  <done>
Post model has Searchable trait with toSearchableArray(), shouldBeSearchable(), and searchableAs() methods.
Published posts return true from shouldBeSearchable(), draft posts return false.
  </done>
</task>

</tasks>

<verification>
1. `composer show algolia/scout-extended` shows version 3.x installed
2. `config/scout.php` exists and references Algolia driver
3. `app/Models/Post.php` includes `use Searchable` trait
4. Post model has all three search methods (toSearchableArray, shouldBeSearchable, searchableAs)
5. .env contains ALGOLIA_APP_ID and ALGOLIA_SECRET placeholders
</verification>

<success_criteria>
- Scout Extended package installed and configured
- Post model prepared for Algolia indexing with proper field selection
- Content truncation prevents 10KB limit errors
- Only published posts will be indexed (shouldBeSearchable filter)
- Environment ready for Algolia credentials
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-integration/05-01-SUMMARY.md`
</output>
