---
phase: 05-search-integration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - resources/views/components/navigation.blade.php
autonomous: false

must_haves:
  truths:
    - "Search bar visible in site navigation"
    - "All published posts indexed in Algolia"
    - "Typeahead shows results as user types"
    - "Typo tolerance works (e.g., 'wordpres' finds 'WordPress')"
    - "New posts auto-sync to Algolia when published (Scout observer working)"
  artifacts:
    - path: "resources/views/components/navigation.blade.php"
      provides: "Navigation with integrated search bar"
      contains: "livewire:search.search-bar"
  key_links:
    - from: "resources/views/components/navigation.blade.php"
      to: "app/Livewire/Search/SearchBar.php"
      via: "Livewire component tag"
      pattern: "<livewire:search.search-bar"
    - from: "App\\Models\\Post"
      to: "Algolia index"
      via: "Scout observer on save/update/delete"
      pattern: "Searchable trait auto-sync"
---

<objective>
Integrate SearchBar into site navigation, import all posts to Algolia, verify auto-sync functionality, and confirm complete search functionality.

Purpose: Complete the search feature by connecting the SearchBar to the navigation, populating the Algolia index with all published posts, and verifying that new/updated posts automatically sync to the search index.
Output: Working typeahead search accessible from every page on the site with automatic index updates.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-search-integration/05-RESEARCH.md
@.planning/phases/05-search-integration/05-01-SUMMARY.md
@.planning/phases/05-search-integration/05-02-SUMMARY.md
@resources/views/components/navigation.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SearchBar to navigation component</name>
  <files>resources/views/components/navigation.blade.php</files>
  <action>
Update the navigation component to include the SearchBar between the tagline and navigation links.

The current structure is:
1. Logo (left)
2. Tagline (center, hidden on mobile)
3. Nav links (right)

Update to:
1. Logo (left)
2. Tagline (hidden on mobile)
3. SearchBar (center, with appropriate width)
4. Nav links (right)

Insert the SearchBar component with responsive styling:

```blade
{{-- Search Bar (hidden on very small screens) --}}
<div class="hidden sm:block flex-1 max-w-xs mx-4">
    <livewire:search.search-bar />
</div>
```

Place this after the tagline span and before the nav element.

The search bar should:
- Be hidden on xs screens (< 640px) to preserve mobile usability
- Have max-width to prevent it from being too wide
- Have horizontal margin for spacing
- Use flex-1 to fill available space
  </action>
  <verify>
Run `grep -l "livewire:search.search-bar" resources/views/components/navigation.blade.php` confirms component is included.
Start dev server and visually confirm search bar appears in navigation.
  </verify>
  <done>
Navigation component includes SearchBar Livewire component with responsive visibility (hidden on xs, visible sm and up).
  </done>
</task>

<task type="auto">
  <name>Task 2: Import all published posts to Algolia</name>
  <files></files>
  <action>
Import all published posts to the Algolia index using Scout's import command.

**Prerequisites check:**
Before running import, verify Algolia credentials are configured:
```bash
php artisan tinker --execute="echo config('scout.algolia.id') ? 'Algolia configured' : 'MISSING ALGOLIA_APP_ID';"
```

If credentials are missing, the plan will pause for user to add them to .env.

**Run the import:**
```bash
php artisan scout:import "App\Models\Post"
```

This will:
1. Query all Post records
2. Filter through shouldBeSearchable() (only published posts)
3. Transform via toSearchableArray() (title, excerpt, content, slug, published_at)
4. Send to Algolia in batches of 500

**Verify the import:**
```bash
php artisan tinker --execute="
\$dbCount = App\\Models\\Post::where('status', 'published')->whereNotNull('published_at')->count();
echo 'Published posts in DB: ' . \$dbCount;
"
```

Expected: ~3,870 posts indexed (actual count may vary based on database state).

**Note:** If import fails with "Record too big" error, content truncation in toSearchableArray() should prevent this. If it still occurs, reduce Str::limit from 5000 to 3000 characters.
  </action>
  <verify>
Run `php artisan scout:import "App\Models\Post"` completes without errors.
Check Algolia dashboard or run a test search in tinker: `App\Models\Post::search('WordPress')->get()->count()` returns results.
  </verify>
  <done>
All published posts (~3,870) are indexed in Algolia. Scout import command completes successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Scout auto-sync for new and updated posts</name>
  <files></files>
  <action>
Verify that Scout's model observers automatically sync changes to Algolia when posts are created, updated, or deleted.

**Test 1: Create a test post and verify it appears in search**

```bash
php artisan tinker --execute="
// Create a test post with a unique, searchable title
\$post = App\\Models\\Post::create([
    'title' => 'AUTOSYNC_TEST_' . time(),
    'slug' => 'autosync-test-' . time(),
    'content' => 'This is a test post to verify Scout auto-sync functionality.',
    'excerpt' => 'Testing Scout auto-sync',
    'status' => 'published',
    'published_at' => now(),
]);
echo 'Created post ID: ' . \$post->id . ' with title: ' . \$post->title;
"
```

Wait 2 seconds for Algolia to index, then search:

```bash
php artisan tinker --execute="
\$title = App\\Models\\Post::where('title', 'like', 'AUTOSYNC_TEST_%')->latest()->first()->title;
\$results = App\\Models\\Post::search(\$title)->get();
echo 'Search for \"' . \$title . '\" found: ' . \$results->count() . ' result(s)';
if (\$results->count() > 0) {
    echo ' - Title: ' . \$results->first()->title;
}
"
```

**Test 2: Update the test post and verify change is searchable**

```bash
php artisan tinker --execute="
\$post = App\\Models\\Post::where('title', 'like', 'AUTOSYNC_TEST_%')->latest()->first();
\$newTitle = 'UPDATED_SYNC_TEST_' . time();
\$post->update(['title' => \$newTitle]);
echo 'Updated post to title: ' . \$newTitle;
"
```

Wait 2 seconds, then search for the updated title:

```bash
php artisan tinker --execute="
\$title = App\\Models\\Post::where('title', 'like', 'UPDATED_SYNC_TEST_%')->latest()->first()->title;
\$results = App\\Models\\Post::search(\$title)->get();
echo 'Search for updated title found: ' . \$results->count() . ' result(s)';
"
```

**Test 3: Clean up test post**

```bash
php artisan tinker --execute="
\$post = App\\Models\\Post::where('title', 'like', 'UPDATED_SYNC_TEST_%')->orWhere('title', 'like', 'AUTOSYNC_TEST_%')->latest()->first();
if (\$post) {
    \$id = \$post->id;
    \$post->delete();
    echo 'Deleted test post ID: ' . \$id;
} else {
    echo 'No test post found to delete';
}
"
```

**Document production queue configuration:**

For production, enable queued indexing for better performance:
1. Set `SCOUT_QUEUE=true` in production .env
2. Ensure queue worker is running: `php artisan queue:work`
3. Scout will dispatch index jobs to the queue instead of syncing synchronously

Current development config uses `SCOUT_QUEUE=false` for immediate feedback during testing.
  </action>
  <verify>
1. Test post creation: New post with unique title appears in Algolia search within seconds
2. Test post update: Changed title is searchable after update
3. Test post deletion: Post is removed from search index after delete (verify by searching for deleted title returns 0 results)
4. No errors in any of the above operations
  </verify>
  <done>
Scout model observers confirmed working: created posts appear in search, updated posts reflect changes, deleted posts are removed from index. Production queue configuration documented.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Algolia-powered search with typeahead functionality:
- Scout Extended configured with Algolia driver
- Post model has Searchable trait with auto-sync observers
- SearchBar Livewire component with debounced typeahead
- Navigation integration showing search on all pages
- All published posts imported to Algolia index
- Auto-sync verified for create/update/delete operations
  </what-built>
  <how-to-verify>
1. Start the development server: `php artisan serve`
2. Open http://127.0.0.1:8000 in browser
3. Verify search bar appears in navigation (visible on desktop, hidden on mobile)
4. Type "WordPress" in search bar:
   - Results should appear after 300ms debounce
   - Should see up to 5 matching posts
   - Each result shows title and excerpt preview
5. Test typo tolerance - type "wordpres" (missing 's'):
   - Should still find WordPress-related posts
   - This confirms Algolia's typo tolerance is working
6. Click a search result:
   - Should navigate to the post
   - Search bar should clear
7. Test keyboard navigation:
   - Use arrow keys to move through results
   - Press Escape to close dropdown
8. Test edge cases:
   - Type single character - no results (min 2 chars)
   - Type something with no matches - shows "No posts found" message
  </how-to-verify>
  <resume-signal>Type "approved" if search works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Navigation includes `<livewire:search.search-bar />` component
2. Search bar visible on desktop, hidden on mobile (<640px)
3. Scout import completed without errors
4. Auto-sync verified: new posts appear in search, updates reflected, deletes removed
5. Typing in search bar shows results from Algolia
6. Typo tolerance works (misspellings still find results)
7. Clicking result navigates to post URL
8. Keyboard navigation functional
</verification>

<success_criteria>
- Search bar integrated into site navigation on all pages
- All published posts indexed in Algolia (count matches database)
- New posts automatically sync to Algolia when published (Scout observers working)
- Updated posts reflect changes in search index
- Typeahead shows instant results as user types (300ms debounce)
- Search handles typos gracefully via Algolia's typo tolerance
- Results link to correct WordPress-style permalinks
- Human verification confirms end-to-end functionality
- Production queue configuration documented (SCOUT_QUEUE=true + queue worker)
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-integration/05-03-SUMMARY.md`
</output>
