---
phase: 06-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/xxxx_add_is_admin_to_users_table.php
  - app/Models/User.php
  - app/Providers/AppServiceProvider.php
  - routes/web.php
  - resources/views/auth/login.blade.php
  - app/Http/Controllers/Auth/LoginController.php
autonomous: true

must_haves:
  truths:
    - "Admin user (is_admin=1) can access /admin routes"
    - "Non-admin users get 403 when accessing /admin routes"
    - "Login page exists at /login and authenticates users"
    - "Gate::before grants admin full access without policy checks"
  artifacts:
    - path: "database/migrations/*_add_is_admin_to_users_table.php"
      provides: "is_admin boolean column on users table"
      contains: "is_admin"
    - path: "app/Models/User.php"
      provides: "isAdmin() helper method"
      contains: "isAdmin"
    - path: "app/Providers/AppServiceProvider.php"
      provides: "Gate::before admin bypass"
      contains: "Gate::before"
    - path: "routes/web.php"
      provides: "Admin route group with auth middleware"
      contains: "prefix('admin')"
  key_links:
    - from: "routes/web.php"
      to: "Gate::before"
      via: "auth middleware + admin check"
      pattern: "middleware.*auth"
---

<objective>
Set up authentication foundation with simple is_admin flag and Gate::before pattern.

Purpose: Enable admin-only access to /admin routes using the simplest possible approach (single boolean flag instead of complex role system).

Output: Migration for is_admin, updated User model, Gate::before in AppServiceProvider, login route, and protected admin route group with ALL placeholder routes.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@app/Models/User.php
@routes/web.php

Reference: https://laravel.com/docs/12.x/authorization (Gate::before pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add is_admin field and Gate::before authorization</name>
  <files>
    database/migrations/2026_01_25_000000_add_is_admin_to_users_table.php
    app/Models/User.php
    app/Providers/AppServiceProvider.php
  </files>
  <action>
1. Create migration to add is_admin boolean to users table:
   - `is_admin` boolean, default false, after `role` column
   - Update jeremy@shoemoney.com to have is_admin=1 in the migration

2. Update User model:
   - Add `is_admin` to $fillable array
   - Add `isAdmin(): bool` method that returns `$this->is_admin`
   - Keep existing role helpers for backward compatibility

3. Add Gate::before in AppServiceProvider boot():
   ```php
   use Illuminate\Support\Facades\Gate;

   Gate::before(function ($user, $ability) {
       if ($user->isAdmin()) {
           return true;
       }
   });
   ```

This pattern grants admin users full access to everything without needing individual policy checks.
  </action>
  <verify>
    php artisan migrate --pretend (shows migration would run)
    grep -r "is_admin" app/Models/User.php (shows field exists)
    grep -r "Gate::before" app/Providers/AppServiceProvider.php (shows gate configured)
  </verify>
  <done>
    - Migration adds is_admin column
    - User model has isAdmin() method
    - Gate::before grants admin full access
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login route and protected admin route group with ALL placeholder routes</name>
  <files>
    routes/web.php
    app/Http/Controllers/Auth/LoginController.php
    resources/views/auth/login.blade.php
  </files>
  <action>
1. Create LoginController with simple email/password auth:
   - showLoginForm() renders login view
   - login(Request $request) validates email/password, uses Auth::attempt()
   - logout() calls Auth::logout() and redirects to home
   - On success, redirect to /admin
   - On failure, redirect back with error

2. Create simple login.blade.php:
   - Use existing layout (components.layouts.app)
   - Form with email, password fields
   - Show validation errors
   - Simple Tailwind styling matching site

3. Add routes to web.php BEFORE the admin group:
   ```php
   // Auth routes
   Route::get('/login', [LoginController::class, 'showLoginForm'])->name('login');
   Route::post('/login', [LoginController::class, 'login']);
   Route::post('/logout', [LoginController::class, 'logout'])->name('logout');
   ```

4. Add admin route group with ALL placeholder routes (so sidebar can reference them):
   ```php
   // Admin routes - protected by auth + admin check
   Route::prefix('admin')
       ->middleware(['auth'])
       ->group(function () {
           // Admin check middleware applied to all admin routes
           Route::middleware(function ($request, $next) {
               if (!$request->user()->isAdmin()) {
                   abort(403, 'Admin access required.');
               }
               return $next($request);
           })->group(function () {
               // Dashboard - placeholder until 06-02 adds Livewire component
               Route::get('/', function () {
                   return 'Admin Dashboard (placeholder - will be replaced by Livewire component)';
               })->name('admin.dashboard');

               // Posts management placeholders
               Route::get('/posts', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Posts management coming soon');
               })->name('admin.posts.index');
               Route::get('/posts/create', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Post creation coming soon');
               })->name('admin.posts.create');
               Route::get('/posts/{post}/edit', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Post editing coming soon');
               })->name('admin.posts.edit');

               // Comments management placeholder
               Route::get('/comments', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Comments management coming soon');
               })->name('admin.comments.index');

               // Categories management placeholder
               Route::get('/categories', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Categories management coming soon');
               })->name('admin.categories.index');

               // Tags management placeholder
               Route::get('/tags', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Tags management coming soon');
               })->name('admin.tags.index');

               // Users management placeholders
               Route::get('/users', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'Users management coming soon');
               })->name('admin.users.index');
               Route::get('/users/create', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'User creation coming soon');
               })->name('admin.users.create');
               Route::get('/users/{user}/edit', function () {
                   return redirect()->route('admin.dashboard')->with('info', 'User editing coming soon');
               })->name('admin.users.edit');
           });
       });
   ```

IMPORTANT: All routes are defined as placeholders now. Later plans will replace these closures with actual Livewire components. This ensures the sidebar navigation in 06-02 can reference all routes immediately.

Note: Place auth routes AFTER sitemap but BEFORE the catch-all page route.
  </action>
  <verify>
    php artisan route:list --path=login (shows login routes)
    php artisan route:list --path=admin (shows ALL admin routes including posts, comments, categories, tags, users)
    curl -I http://localhost:8000/admin (returns 302 redirect to login)
  </verify>
  <done>
    - Login page accessible at /login
    - Admin route group protected by auth middleware
    - ALL admin routes exist as named placeholders (dashboard, posts.*, comments.*, categories.*, tags.*, users.*)
    - Non-admin users get 403 on /admin (after login)
    - Admin users can access /admin
    - Sidebar in 06-02 can safely use route() helper for all navigation links
  </done>
</task>

<task type="auto">
  <name>Task 3: Run migration and verify admin access</name>
  <files>None (database operation)</files>
  <action>
1. Run the migration:
   ```bash
   php artisan migrate
   ```

2. Verify jeremy@shoemoney.com has is_admin=1:
   ```bash
   php artisan tinker --execute="echo App\Models\User::where('email', 'jeremy@shoemoney.com')->value('is_admin')"
   ```

3. If is_admin is not set (migration didn't update), run:
   ```bash
   php artisan tinker --execute="App\Models\User::where('email', 'jeremy@shoemoney.com')->update(['is_admin' => true])"
   ```

4. Test the flow:
   - Start dev server if not running: php artisan serve
   - Visit /admin (should redirect to /login)
   - Log in with admin credentials
   - Should see admin placeholder
  </action>
  <verify>
    php artisan tinker --execute="App\Models\User::where('email', 'jeremy@shoemoney.com')->first(['email', 'is_admin'])"
    (shows is_admin = 1)
  </verify>
  <done>
    - Migration executed successfully
    - jeremy@shoemoney.com has is_admin=1
    - Login -> /admin flow works
  </done>
</task>

</tasks>

<verification>
- [ ] `php artisan migrate` runs without errors
- [ ] User model has isAdmin() method returning correct value
- [ ] Gate::before configured in AppServiceProvider
- [ ] /login route renders login form
- [ ] /admin redirects to /login when not authenticated
- [ ] Admin user can log in and access /admin
- [ ] Non-admin user gets 403 after login when accessing /admin
- [ ] All admin routes exist: dashboard, posts.index, posts.create, posts.edit, comments.index, categories.index, tags.index, users.index, users.create, users.edit
</verification>

<success_criteria>
1. is_admin boolean column exists on users table
2. jeremy@shoemoney.com has is_admin=1
3. User::isAdmin() method works correctly
4. Gate::before grants admin full authorization bypass
5. /login page exists and authenticates users
6. /admin route group protected by auth middleware
7. Non-admin users receive 403 on admin routes
8. ALL admin routes defined as named placeholders for sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-panel/06-01-SUMMARY.md`
</output>
