---
phase: 06-admin-panel
plan: 06
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/Livewire/Admin/Users/UserIndex.php
  - resources/views/livewire/admin/users/user-index.blade.php
  - app/Livewire/Admin/Users/UserForm.php
  - resources/views/livewire/admin/users/user-form.blade.php
  - routes/web.php
autonomous: true

must_haves:
  truths:
    - "Admin can see list of all users"
    - "Admin can create a new user account"
    - "Admin can edit user details"
    - "Admin can grant/revoke admin access"
    - "Admin can delete non-admin users"
  artifacts:
    - path: "app/Livewire/Admin/Users/UserIndex.php"
      provides: "User listing with admin badges"
      contains: "is_admin"
    - path: "app/Livewire/Admin/Users/UserForm.php"
      provides: "User create/edit form"
      contains: "save"
  key_links:
    - from: "app/Livewire/Admin/Users/UserForm.php"
      to: "App\\Models\\User"
      via: "Eloquent create/update"
      pattern: "User::"
---

<objective>
Create user management interface for admin to manage user accounts.

Purpose: Enable admin to create new authors, manage their details, and control admin access (is_admin flag).

Output: UserIndex and UserForm Livewire components for user CRUD.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-admin-panel/06-RESEARCH.md
@app/Models/User.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserIndex component</name>
  <files>
    app/Livewire/Admin/Users/UserIndex.php
    resources/views/livewire/admin/users/user-index.blade.php
    routes/web.php
  </files>
  <action>
1. Create UserIndex component:
   - Use WithPagination trait
   - Properties: $search (string)
   - updatingSearch() calls resetPage()
   - delete(User $user) method:
     - Cannot delete self (auth()->id())
     - Cannot delete another admin
     - Deletes user, flash success
   - toggleAdmin(User $user) method:
     - Cannot modify self
     - Toggles is_admin boolean
     - Flash success message
   - render() returns users with posts count, filtered by search, paginated(20)

2. Create view:
   - Header: "Users" with "New User" button linking to admin.users.create
   - Search input (wire:model.live.debounce.300ms)
   - Table with columns:
     - Name (display_name accessor)
     - Email
     - Admin badge (if is_admin)
     - Posts count
     - Joined date
     - Actions (Edit, Toggle Admin, Delete)
   - Toggle Admin button: shows "Make Admin" or "Remove Admin" based on current state
   - Delete button disabled for self and other admins
   - Pagination

3. Add route:
   ```php
   Route::get('/users', \App\Livewire\Admin\Users\UserIndex::class)->name('admin.users.index');
   ```
  </action>
  <verify>
    php artisan livewire:list | grep UserIndex
    php artisan route:list --path=admin/users
  </verify>
  <done>
    - UserIndex lists all users with pagination
    - Search filters by name/email
    - Admin badge shows for admin users
    - Toggle admin works (except on self)
    - Delete works (except self and admins)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserForm component for create/edit</name>
  <files>
    app/Livewire/Admin/Users/UserForm.php
    resources/views/livewire/admin/users/user-form.blade.php
    routes/web.php
  </files>
  <action>
1. Create UserForm component:
   - Properties: $user (nullable), $name, $email, $author_name, $password, $password_confirmation, $is_admin = false
   - mount(?User $user = null): if user provided, populate fields (edit mode)
   - Validation:
     - name: required|string|max:255
     - email: required|email|unique:users (exclude current user id if editing)
     - author_name: nullable|string|max:255
     - password: required on create, nullable on edit, min:8, confirmed
     - is_admin: boolean
   - save() method:
     - If editing: update user, only update password if provided
     - If creating: create user with hashed password
     - Redirect to users.index with success message
   - Computed property or method isEditing() to check if $user is set

2. Create view:
   - Header: "Create User" or "Edit User" based on mode
   - Form fields:
     - Name (wire:model)
     - Email (wire:model)
     - Author Name / Display Name (wire:model)
     - Password (wire:model) - with note "Leave blank to keep current" on edit
     - Password Confirmation (wire:model)
     - Is Admin checkbox (wire:model)
   - Save and Cancel buttons
   - Validation error display

3. Add routes:
   ```php
   Route::get('/users/create', \App\Livewire\Admin\Users\UserForm::class)->name('admin.users.create');
   Route::get('/users/{user}/edit', \App\Livewire\Admin\Users\UserForm::class)->name('admin.users.edit');
   ```

Note: Password field uses Laravel's 'hashed' cast on User model, so just assign the value and Laravel handles hashing.
  </action>
  <verify>
    php artisan livewire:list | grep UserForm
    php artisan route:list --path=admin/users
  </verify>
  <done>
    - UserForm creates new users with hashed passwords
    - UserForm edits existing users
    - Password optional on edit (keeps existing)
    - Is Admin checkbox controls admin access
    - Validation prevents duplicate emails
  </done>
</task>

</tasks>

<verification>
- [ ] /admin/users shows all users with pagination
- [ ] Search filters users by name/email
- [ ] Admin badge displays correctly
- [ ] "New User" links to create form
- [ ] Create form saves new user with hashed password
- [ ] Edit form loads existing user data
- [ ] Edit form updates user (password optional)
- [ ] Toggle Admin changes is_admin flag
- [ ] Cannot toggle admin on self
- [ ] Cannot delete self or other admins
- [ ] Delete removes user after confirmation
</verification>

<success_criteria>
1. Admin can view all users in paginated list
2. Admin can search users by name/email
3. Admin can create new user with password
4. Admin can edit existing user details
5. Admin can grant/revoke admin access (except self)
6. Admin cannot delete self or other admins
7. Passwords are properly hashed
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-panel/06-06-SUMMARY.md`
</output>
