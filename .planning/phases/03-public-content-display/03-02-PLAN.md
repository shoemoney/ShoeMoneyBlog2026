---
phase: 03-public-content-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Services/ShortcodeProcessor.php
  - app/Models/Post.php
  - app/Models/Page.php
  - app/Providers/AppServiceProvider.php
autonomous: true

must_haves:
  truths:
    - "WordPress shortcodes convert to HTML when rendering content"
    - "Posts have rendered_content accessor for processed HTML"
    - "Posts have reading_time accessor showing minutes to read"
  artifacts:
    - path: "app/Services/ShortcodeProcessor.php"
      provides: "Shortcode to HTML conversion"
      exports: ["process"]
    - path: "app/Models/Post.php"
      provides: "rendered_content and reading_time accessors"
      contains: "renderedContent"
  key_links:
    - from: "app/Models/Post.php"
      to: "app/Services/ShortcodeProcessor.php"
      via: "app() container resolution"
      pattern: "app\\(ShortcodeProcessor"
---

<objective>
Create ShortcodeProcessor service and add content accessors to Post/Page models.

Purpose: Transform WordPress shortcodes into proper HTML for display, calculate reading time.
Output: ShortcodeProcessor service class, Post/Page model accessors for rendered content.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-public-content-display/03-RESEARCH.md

Reference files:
@app/Models/Post.php
@app/Models/Page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShortcodeProcessor service</name>
  <files>app/Services/ShortcodeProcessor.php</files>
  <action>
Create app/Services/ShortcodeProcessor.php with:

1. process(string $content): string method that handles:
   - [more] -> `<hr class="wp-more">` (read more break)
   - [caption ...] content [/caption] -> `<figure class="wp-caption">` with figcaption
   - [video mp4="..." webm="..." poster="..."] -> HTML5 video element
   - [gravityform ...] -> placeholder div with contact link
   - Unknown shortcodes -> strip them (fallback: preg_replace('/\[[^\]]+\]/', '', $content))

2. Private helper methods:
   - processCaption(string $full, string $inner): string
   - processVideo(string $attrs): string

Follow the exact patterns from 03-RESEARCH.md. Use regex patterns that handle attributes in any order.

Important: Caption shortcode may have attributes like width="300", align="alignnone", caption="text" in any order.
  </action>
  <verify>
Create simple test: echo app(ShortcodeProcessor::class)->process('[more]') outputs '<hr class="wp-more">'
  </verify>
  <done>ShortcodeProcessor converts [more], [caption], [video], [gravityform] shortcodes to HTML</done>
</task>

<task type="auto">
  <name>Task 2: Add content accessors to Post model</name>
  <files>app/Models/Post.php</files>
  <action>
Add to app/Models/Post.php:

1. Import at top:
   - use App\Services\ShortcodeProcessor;
   - use Illuminate\Database\Eloquent\Casts\Attribute;

2. Add renderedContent accessor:
```php
protected function renderedContent(): Attribute
{
    return Attribute::make(
        get: function () {
            $processor = app(ShortcodeProcessor::class);
            return $processor->process($this->content ?? '');
        }
    )->shouldCache();
}
```

3. Add readingTime accessor:
```php
protected function readingTime(): Attribute
{
    return Attribute::make(
        get: fn () => max(1, (int) ceil(str_word_count(strip_tags($this->content ?? '')) / 200))
    )->shouldCache();
}
```

Both accessors use shouldCache() to prevent recomputation on multiple accesses.
  </action>
  <verify>
php artisan tinker: Post::first()->rendered_content returns HTML
php artisan tinker: Post::first()->reading_time returns integer
  </verify>
  <done>Post model has rendered_content and reading_time accessors</done>
</task>

<task type="auto">
  <name>Task 3: Add content accessor to Page model</name>
  <files>app/Models/Page.php</files>
  <action>
Add to app/Models/Page.php:

1. Import at top:
   - use App\Services\ShortcodeProcessor;
   - use Illuminate\Database\Eloquent\Casts\Attribute;

2. Add renderedContent accessor (same pattern as Post):
```php
protected function renderedContent(): Attribute
{
    return Attribute::make(
        get: function () {
            $processor = app(ShortcodeProcessor::class);
            return $processor->process($this->content ?? '');
        }
    )->shouldCache();
}
```

Pages don't need reading_time since they're typically short static pages.
  </action>
  <verify>
php artisan tinker: Page::first()->rendered_content returns HTML
  </verify>
  <done>Page model has rendered_content accessor</done>
</task>

</tasks>

<verification>
- php artisan tinker: app(ShortcodeProcessor::class) instantiates without error
- Post::first()->rendered_content returns processed HTML
- Post::first()->reading_time returns positive integer
- Page::first()->rendered_content returns processed HTML
</verification>

<success_criteria>
- ShortcodeProcessor handles top 4 shortcode types
- Unknown shortcodes are stripped (no raw [shortcode] in output)
- Accessors cached to prevent recomputation
- Models remain backward compatible (content still accessible directly)
</success_criteria>

<output>
After completion, create `.planning/phases/03-public-content-display/03-02-SUMMARY.md`
</output>
