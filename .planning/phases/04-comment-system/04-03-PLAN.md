---
phase: 04-comment-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/Livewire/Comments/CommentSection.php
  - resources/views/livewire/comments/comment-section.blade.php
  - resources/views/livewire/comments/comment-item.blade.php
autonomous: true

must_haves:
  truths:
    - "User can see existing comments on posts"
    - "Comments display with proper threading (replies indented under parents)"
    - "Gravatar avatars display next to comments"
    - "Maximum nesting depth is 3 levels"
  artifacts:
    - path: "app/Livewire/Comments/CommentSection.php"
      provides: "Parent component loading comments"
      exports: ["render", "startReply", "cancelReply"]
    - path: "resources/views/livewire/comments/comment-section.blade.php"
      provides: "Comment section container view"
      contains: "comment-item"
    - path: "resources/views/livewire/comments/comment-item.blade.php"
      provides: "Individual comment display with recursion"
      contains: "gravatar_url"
  key_links:
    - from: "app/Livewire/Comments/CommentSection.php"
      to: "App\\Models\\Comment"
      via: "Eloquent query with eager loading"
      pattern: "with.*replies"
    - from: "resources/views/livewire/comments/comment-item.blade.php"
      to: "comment-item.blade.php"
      via: "Recursive @include for nested replies"
      pattern: "@include.*comment-item"
---

<objective>
Create CommentSection component for displaying threaded comments with Gravatar avatars

Purpose: Enable users to view existing comments on posts with proper visual threading
Output: Livewire component displaying approved comments with nesting up to 3 levels
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comment-system/04-RESEARCH.md
@.planning/phases/04-comment-system/04-01-SUMMARY.md

@app/Models/Comment.php
@app/Models/Post.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentSection Livewire component</name>
  <files>app/Livewire/Comments/CommentSection.php</files>
  <action>
Create `app/Livewire/Comments/CommentSection.php`:

```php
<?php

namespace App\Livewire\Comments;

use App\Models\Post;
use Livewire\Attributes\On;
use Livewire\Component;

class CommentSection extends Component
{
    public Post $post;
    public ?int $replyingTo = null;
    public bool $showPendingMessage = false;

    public function mount(Post $post): void
    {
        $this->post = $post;
    }

    public function startReply(int $commentId): void
    {
        $this->replyingTo = $commentId;
    }

    public function cancelReply(): void
    {
        $this->replyingTo = null;
    }

    #[On('comment-submitted')]
    public function handleCommentSubmitted(bool $isPending = false): void
    {
        $this->replyingTo = null;
        $this->showPendingMessage = $isPending;
    }

    public function render()
    {
        // Load root comments with nested replies (3 levels deep)
        // Each level filters for approved comments only
        $comments = $this->post->comments()
            ->rootComments()
            ->approved()
            ->with([
                'replies' => fn($q) => $q->approved()->with([
                    'replies' => fn($q2) => $q2->approved()->with([
                        'replies' => fn($q3) => $q3->approved()
                    ])
                ])
            ])
            ->orderBy('created_at', 'asc')
            ->get();

        $commentCount = $this->post->comments()->approved()->count();

        return view('livewire.comments.comment-section', [
            'comments' => $comments,
            'commentCount' => $commentCount,
        ]);
    }
}
```

Key implementation details:
- Uses `rootComments()` scope to get only top-level comments
- Eager loads 3 levels of replies with `approved()` scope at each level
- Tracks `$replyingTo` for positioning reply form
- Listens for `comment-submitted` event to refresh and show pending message
  </action>
  <verify>
Run `php artisan tinker --execute="new \App\Livewire\Comments\CommentSection()"` - instantiates without error
  </verify>
  <done>CommentSection component created with comment loading and reply state management</done>
</task>

<task type="auto">
  <name>Task 2: Create comment section view</name>
  <files>resources/views/livewire/comments/comment-section.blade.php</files>
  <action>
Create `resources/views/livewire/comments/comment-section.blade.php`:

```blade
<section class="space-y-8">
    <h2 class="text-2xl font-bold text-gray-900">
        {{ $commentCount }} {{ Str::plural('Comment', $commentCount) }}
    </h2>

    @if($showPendingMessage)
        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-yellow-800">
                Your comment is awaiting moderation and will appear once approved.
            </p>
        </div>
    @endif

    {{-- New comment form at top --}}
    <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Leave a Comment</h3>
        <livewire:comments.comment-form :post="$post" :key="'new-comment'" />
    </div>

    {{-- Comment list --}}
    @if($comments->isNotEmpty())
        <div class="space-y-6">
            @foreach($comments as $comment)
                @include('livewire.comments.comment-item', ['comment' => $comment, 'depth' => 0])
            @endforeach
        </div>
    @else
        <p class="text-gray-500 italic">No comments yet. Be the first to comment!</p>
    @endif
</section>
```

Note: The `<livewire:comments.comment-form>` will be implemented in Plan 04. For now this will show an error if accessed directly - that's expected.
  </action>
  <verify>
Run `ls resources/views/livewire/comments/comment-section.blade.php` - file exists
  </verify>
  <done>Comment section view created with comment list and placeholder for form</done>
</task>

<task type="auto">
  <name>Task 3: Create comment item partial with recursion</name>
  <files>resources/views/livewire/comments/comment-item.blade.php</files>
  <action>
Create `resources/views/livewire/comments/comment-item.blade.php`:

```blade
@props(['comment', 'depth' => 0])

<div class="comment {{ $depth > 0 ? 'ml-8 border-l-2 border-gray-200 pl-4' : '' }}"
     id="comment-{{ $comment->id }}">
    <div class="flex space-x-4">
        {{-- Gravatar avatar --}}
        <img src="{{ $comment->gravatar_url }}"
             alt="{{ $comment->author_name }}"
             class="w-12 h-12 rounded-full flex-shrink-0"
             loading="lazy">

        <div class="flex-1 min-w-0">
            {{-- Comment header --}}
            <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                <span class="font-semibold text-gray-900">
                    @if($comment->author_url)
                        <a href="{{ $comment->author_url }}"
                           rel="nofollow noopener"
                           target="_blank"
                           class="hover:text-blue-600 hover:underline">
                            {{ $comment->author_name }}
                        </a>
                    @else
                        {{ $comment->author_name }}
                    @endif
                </span>
                <time class="text-sm text-gray-500"
                      datetime="{{ $comment->created_at->toIso8601String() }}">
                    {{ $comment->created_at->diffForHumans() }}
                </time>
            </div>

            {{-- Comment content --}}
            <div class="mt-2 prose prose-sm max-w-none text-gray-700">
                {!! nl2br(e($comment->content)) !!}
            </div>

            {{-- Reply button (only show if depth < 3) --}}
            @if($depth < 3)
                <button wire:click="startReply({{ $comment->id }})"
                        class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
                    Reply
                </button>
            @endif

            {{-- Inline reply form when replying to this comment --}}
            @if($this->replyingTo === $comment->id)
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-600">
                            Replying to {{ $comment->author_name }}
                        </span>
                        <button wire:click="cancelReply"
                                class="text-sm text-gray-500 hover:text-gray-700">
                            Cancel
                        </button>
                    </div>
                    <livewire:comments.comment-form
                        :post="$post"
                        :parent-id="$comment->id"
                        :key="'reply-' . $comment->id" />
                </div>
            @endif
        </div>
    </div>

    {{-- Nested replies (recursive, max 3 levels) --}}
    @if($comment->replies->isNotEmpty() && $depth < 3)
        <div class="mt-4 space-y-4">
            @foreach($comment->replies as $reply)
                @include('livewire.comments.comment-item', ['comment' => $reply, 'depth' => $depth + 1])
            @endforeach
        </div>
    @endif
</div>
```

Key implementation details:
- Uses `$depth` prop to track nesting level (0-3)
- Applies left margin and border for visual indentation at depth > 0
- Uses `e()` to escape content, `nl2br()` to preserve line breaks
- Gravatar with `loading="lazy"` for performance
- Reply button hidden at depth 3 (max nesting)
- Recursive `@include` for nested replies
- Links have `rel="nofollow noopener"` for security and SEO
  </action>
  <verify>
Run `ls resources/views/livewire/comments/comment-item.blade.php` - file exists
Run `grep "gravatar_url" resources/views/livewire/comments/comment-item.blade.php` - contains gravatar reference
Run `grep "@include.*comment-item" resources/views/livewire/comments/comment-item.blade.php` - contains recursive include
  </verify>
  <done>Comment item partial created with threading, Gravatar, and recursive reply display</done>
</task>

</tasks>

<verification>
- CommentSection component can be instantiated without errors
- View files exist in correct locations
- Recursive include syntax is correct
- Gravatar URLs will be generated from Comment model's accessor
</verification>

<success_criteria>
1. CommentSection.php loads comments with 3-level eager loading
2. Only approved comments are displayed
3. Comments show Gravatar avatar, author name, timestamp, content
4. Reply button visible for depth 0-2, hidden at depth 3
5. Visual indentation applied for nested replies
6. Empty state message when no comments exist
</success_criteria>

<output>
After completion, create `.planning/phases/04-comment-system/04-03-SUMMARY.md`
</output>
