---
phase: 04-comment-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Services/CommentModerationService.php
  - tests/Unit/CommentModerationServiceTest.php
autonomous: true

must_haves:
  truths:
    - "First-time commenters get pending status"
    - "Previously approved commenters get auto-approved status"
    - "Email comparison is case-insensitive"
  artifacts:
    - path: "app/Services/CommentModerationService.php"
      provides: "Moderation status determination"
      exports: ["determineStatus"]
    - path: "tests/Unit/CommentModerationServiceTest.php"
      provides: "Test coverage for moderation logic"
      min_lines: 30
  key_links:
    - from: "app/Services/CommentModerationService.php"
      to: "App\\Models\\Comment"
      via: "Eloquent query for approved comments"
      pattern: "Comment::where"
---

<objective>
Create CommentModerationService with auto-approval logic and tests

Purpose: Implement WordPress-style comment moderation where previously approved commenters bypass moderation
Output: Service class with determineStatus() method and unit tests
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comment-system/04-RESEARCH.md

@app/Models/Comment.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentModerationService</name>
  <files>app/Services/CommentModerationService.php</files>
  <action>
Create directory and service class:
```bash
mkdir -p app/Services
```

Create `app/Services/CommentModerationService.php`:

```php
<?php

namespace App\Services;

use App\Models\Comment;

class CommentModerationService
{
    /**
     * Determine the status for a new comment.
     *
     * Returns 'approved' if the email has any previously approved comment.
     * Returns 'pending' for first-time commenters.
     *
     * @param string $email The commenter's email address
     * @return string 'approved' or 'pending'
     */
    public function determineStatus(string $email): string
    {
        $normalizedEmail = strtolower(trim($email));

        $hasApprovedComment = Comment::where('author_email', $normalizedEmail)
            ->where('status', 'approved')
            ->exists();

        return $hasApprovedComment ? 'approved' : 'pending';
    }
}
```

Key implementation details:
- Email is normalized (lowercase, trimmed) before lookup
- Uses `exists()` for efficient boolean check (not loading full records)
- Returns string status to match Comment model's status field values
  </action>
  <verify>
Run `php artisan tinker --execute="app(\App\Services\CommentModerationService::class)"` - instantiates without error
  </verify>
  <done>CommentModerationService created with determineStatus method</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for moderation service</name>
  <files>tests/Unit/CommentModerationServiceTest.php</files>
  <action>
Create `tests/Unit/CommentModerationServiceTest.php`:

```php
<?php

namespace Tests\Unit;

use App\Models\Comment;
use App\Models\Post;
use App\Services\CommentModerationService;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class CommentModerationServiceTest extends TestCase
{
    use RefreshDatabase;

    private CommentModerationService $service;

    protected function setUp(): void
    {
        parent::setUp();
        $this->service = new CommentModerationService();
    }

    public function test_first_time_commenter_returns_pending(): void
    {
        $status = $this->service->determineStatus('newuser@example.com');

        $this->assertEquals('pending', $status);
    }

    public function test_previously_approved_commenter_returns_approved(): void
    {
        // Create a post for the comment
        $post = Post::factory()->create();

        // Create an approved comment from this email
        Comment::factory()->create([
            'post_id' => $post->id,
            'author_email' => 'returning@example.com',
            'status' => 'approved',
        ]);

        $status = $this->service->determineStatus('returning@example.com');

        $this->assertEquals('approved', $status);
    }

    public function test_pending_comment_does_not_grant_approval(): void
    {
        $post = Post::factory()->create();

        // Create a pending comment (not approved)
        Comment::factory()->create([
            'post_id' => $post->id,
            'author_email' => 'pending@example.com',
            'status' => 'pending',
        ]);

        $status = $this->service->determineStatus('pending@example.com');

        $this->assertEquals('pending', $status);
    }

    public function test_email_comparison_is_case_insensitive(): void
    {
        $post = Post::factory()->create();

        Comment::factory()->create([
            'post_id' => $post->id,
            'author_email' => 'user@example.com',
            'status' => 'approved',
        ]);

        // Query with uppercase email
        $status = $this->service->determineStatus('USER@EXAMPLE.COM');

        $this->assertEquals('approved', $status);
    }

    public function test_email_is_trimmed(): void
    {
        $post = Post::factory()->create();

        Comment::factory()->create([
            'post_id' => $post->id,
            'author_email' => 'trim@example.com',
            'status' => 'approved',
        ]);

        // Query with whitespace
        $status = $this->service->determineStatus('  trim@example.com  ');

        $this->assertEquals('approved', $status);
    }
}
```

Note: Tests use RefreshDatabase to ensure isolation. The Comment model already has a factory (from Phase 1).
  </action>
  <verify>
Run `php artisan test --filter=CommentModerationServiceTest` - all tests pass
  </verify>
  <done>5 unit tests pass covering moderation logic edge cases</done>
</task>

</tasks>

<verification>
- `php artisan test --filter=CommentModerationServiceTest` - all 5 tests pass
- Service can be resolved from container: `app(CommentModerationService::class)`
- No N+1 or performance issues - uses `exists()` not `get()->count()`
</verification>

<success_criteria>
1. CommentModerationService exists with determineStatus() method
2. First-time commenters return 'pending' status
3. Previously approved email returns 'approved' status
4. Email lookup is case-insensitive and trims whitespace
5. All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-comment-system/04-02-SUMMARY.md`
</output>
