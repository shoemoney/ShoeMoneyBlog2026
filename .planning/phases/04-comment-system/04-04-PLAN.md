---
phase: 04-comment-system
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - app/Livewire/Comments/CommentForm.php
  - resources/views/livewire/comments/comment-form.blade.php
autonomous: true

must_haves:
  truths:
    - "User can submit comment with name, email, and body"
    - "First-time commenters get pending status"
    - "Previously approved commenters auto-approved"
    - "Spam protection active via honeypot"
    - "Rate limiting prevents rapid submissions"
  artifacts:
    - path: "app/Livewire/Comments/CommentForm.php"
      provides: "Comment submission handling"
      exports: ["submit", "mount"]
    - path: "resources/views/livewire/comments/comment-form.blade.php"
      provides: "Comment form UI"
      contains: "x-honeypot"
  key_links:
    - from: "app/Livewire/Comments/CommentForm.php"
      to: "App\\Services\\CommentModerationService"
      via: "Dependency injection in submit method"
      pattern: "CommentModerationService.*determineStatus"
    - from: "app/Livewire/Comments/CommentForm.php"
      to: "App\\Models\\Comment"
      via: "Eloquent create"
      pattern: "Comment::create"
---

<objective>
Create CommentForm Livewire component for submitting new comments

Purpose: Enable users to submit comments with validation, spam protection, and auto-moderation
Output: Livewire form component with honeypot, rate limiting, and moderation integration
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comment-system/04-RESEARCH.md
@.planning/phases/04-comment-system/04-01-SUMMARY.md
@.planning/phases/04-comment-system/04-02-SUMMARY.md

@app/Models/Comment.php
@app/Services/CommentModerationService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentForm Livewire component</name>
  <files>app/Livewire/Comments/CommentForm.php</files>
  <action>
Create `app/Livewire/Comments/CommentForm.php`:

```php
<?php

namespace App\Livewire\Comments;

use App\Models\Comment;
use App\Models\Post;
use App\Services\CommentModerationService;
use DanHarrin\LivewireRateLimiting\Exceptions\TooManyRequestsException;
use DanHarrin\LivewireRateLimiting\WithRateLimiting;
use Livewire\Attributes\Validate;
use Livewire\Component;
use Spatie\Honeypot\Http\Livewire\Concerns\HoneypotData;
use Spatie\Honeypot\Http\Livewire\Concerns\UsesSpamProtection;

class CommentForm extends Component
{
    use UsesSpamProtection;
    use WithRateLimiting;

    public Post $post;
    public ?int $parentId = null;

    #[Validate('required|string|min:2|max:100')]
    public string $authorName = '';

    #[Validate('required|email|max:255')]
    public string $authorEmail = '';

    #[Validate('nullable|url|max:255')]
    public ?string $authorUrl = null;

    #[Validate('required|string|min:3|max:10000')]
    public string $content = '';

    public HoneypotData $extraFields;

    public function mount(Post $post, ?int $parentId = null): void
    {
        $this->post = $post;
        $this->parentId = $parentId;
        $this->extraFields = new HoneypotData();
    }

    public function submit(CommentModerationService $moderation): void
    {
        // Rate limiting: 5 comments per minute
        try {
            $this->rateLimit(5, 60);
        } catch (TooManyRequestsException $e) {
            $this->addError('content', 'Too many comments. Please wait a minute before posting again.');
            return;
        }

        // Spam protection (throws exception if honeypot triggered)
        $this->protectAgainstSpam();

        // Validation
        $this->validate();

        // Determine moderation status based on email history
        $normalizedEmail = strtolower(trim($this->authorEmail));
        $status = $moderation->determineStatus($normalizedEmail);

        // Create the comment
        Comment::create([
            'post_id' => $this->post->id,
            'parent_id' => $this->parentId,
            'author_name' => trim($this->authorName),
            'author_email' => $normalizedEmail,
            'author_url' => $this->authorUrl ? trim($this->authorUrl) : null,
            'author_ip' => request()->ip(),
            'content' => trim($this->content),
            'status' => $status,
        ]);

        // Reset content field (keep name/email for convenience)
        $this->reset(['content']);

        // Notify parent component
        $this->dispatch('comment-submitted', isPending: $status === 'pending');
    }

    public function render()
    {
        return view('livewire.comments.comment-form');
    }
}
```

Key implementation details:
- Uses `UsesSpamProtection` trait for honeypot integration
- Uses `WithRateLimiting` trait for rate limiting (5 per minute)
- Validation via `#[Validate]` attributes on properties
- Injects `CommentModerationService` for status determination
- Dispatches event to parent with pending status flag
- Keeps name/email after submit for convenience
  </action>
  <verify>
Run `php artisan tinker --execute="new \App\Livewire\Comments\CommentForm()"` - instantiates without error (will have null $post, that's OK)
  </verify>
  <done>CommentForm component created with validation, spam protection, and moderation</done>
</task>

<task type="auto">
  <name>Task 2: Create comment form view</name>
  <files>resources/views/livewire/comments/comment-form.blade.php</files>
  <action>
Create `resources/views/livewire/comments/comment-form.blade.php`:

```blade
<form wire:submit="submit" class="space-y-4">
    {{-- Honeypot spam trap (invisible) --}}
    <x-honeypot livewire-model="extraFields" />

    {{-- Name and Email row --}}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label for="authorName-{{ $parentId ?? 'new' }}"
                   class="block text-sm font-medium text-gray-700">
                Name <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   id="authorName-{{ $parentId ?? 'new' }}"
                   wire:model.blur="authorName"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                          focus:border-blue-500 focus:ring-blue-500
                          @error('authorName') border-red-500 @enderror"
                   placeholder="Your name">
            @error('authorName')
                <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
            @enderror
        </div>

        <div>
            <label for="authorEmail-{{ $parentId ?? 'new' }}"
                   class="block text-sm font-medium text-gray-700">
                Email <span class="text-red-500">*</span>
                <span class="text-gray-400 font-normal">(not published)</span>
            </label>
            <input type="email"
                   id="authorEmail-{{ $parentId ?? 'new' }}"
                   wire:model.blur="authorEmail"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                          focus:border-blue-500 focus:ring-blue-500
                          @error('authorEmail') border-red-500 @enderror"
                   placeholder="you@example.com">
            @error('authorEmail')
                <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
            @enderror
        </div>
    </div>

    {{-- Website (optional) --}}
    <div>
        <label for="authorUrl-{{ $parentId ?? 'new' }}"
               class="block text-sm font-medium text-gray-700">
            Website <span class="text-gray-400 font-normal">(optional)</span>
        </label>
        <input type="url"
               id="authorUrl-{{ $parentId ?? 'new' }}"
               wire:model.blur="authorUrl"
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                      focus:border-blue-500 focus:ring-blue-500
                      @error('authorUrl') border-red-500 @enderror"
               placeholder="https://yourwebsite.com">
        @error('authorUrl')
            <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
        @enderror
    </div>

    {{-- Comment content --}}
    <div>
        <label for="content-{{ $parentId ?? 'new' }}"
               class="block text-sm font-medium text-gray-700">
            Comment <span class="text-red-500">*</span>
        </label>
        <textarea id="content-{{ $parentId ?? 'new' }}"
                  wire:model="content"
                  rows="4"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                         focus:border-blue-500 focus:ring-blue-500
                         @error('content') border-red-500 @enderror"
                  placeholder="Write your comment..."></textarea>
        @error('content')
            <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
        @enderror
    </div>

    {{-- Submit button --}}
    <div class="flex items-center justify-between">
        <button type="submit"
                wire:loading.attr="disabled"
                wire:loading.class="opacity-50 cursor-not-allowed"
                class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md
                       hover:bg-blue-700 focus:outline-none focus:ring-2
                       focus:ring-blue-500 focus:ring-offset-2
                       disabled:opacity-50 disabled:cursor-not-allowed">
            <span wire:loading.remove wire:target="submit">
                {{ $parentId ? 'Post Reply' : 'Post Comment' }}
            </span>
            <span wire:loading wire:target="submit">
                Posting...
            </span>
        </button>

        <p class="text-sm text-gray-500">
            <span class="text-red-500">*</span> Required fields
        </p>
    </div>
</form>
```

Key implementation details:
- Unique IDs using `$parentId` suffix to avoid conflicts when multiple forms present
- `wire:model.blur` on text fields (validate on blur, reduce server requests)
- `wire:model` on textarea (for real-time character count if added later)
- Loading state on submit button
- Error display below each field
- Honeypot included but invisible to users
- Tailwind form classes for consistent styling with existing site
  </action>
  <verify>
Run `ls resources/views/livewire/comments/comment-form.blade.php` - file exists
Run `grep "x-honeypot" resources/views/livewire/comments/comment-form.blade.php` - contains honeypot
Run `grep "wire:submit" resources/views/livewire/comments/comment-form.blade.php` - contains form submission
  </verify>
  <done>Comment form view created with all fields, validation display, and spam protection</done>
</task>

</tasks>

<verification>
- CommentForm component can be instantiated
- Form contains all required fields (name, email, content)
- Honeypot included in form
- Rate limiting configured (5 per minute)
- Validation attributes on all required fields
- Dispatch event after successful submission
</verification>

<success_criteria>
1. CommentForm accepts name, email, optional URL, and content
2. Validation errors display inline below fields
3. Honeypot spam protection active
4. Rate limiting prevents more than 5 comments per minute
5. New comments use CommentModerationService for status
6. Event dispatched to parent after successful submission
7. Content field resets, name/email preserved after submit
</success_criteria>

<output>
After completion, create `.planning/phases/04-comment-system/04-04-SUMMARY.md`
</output>
