---
phase: 04-comment-system
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - resources/views/posts/show.blade.php
autonomous: false

must_haves:
  truths:
    - "User can view threaded comments on post pages"
    - "User can submit comment and see pending message"
    - "Gravatar avatars display correctly"
    - "Reply functionality works with proper nesting"
  artifacts:
    - path: "resources/views/posts/show.blade.php"
      provides: "Post view with integrated comments"
      contains: "livewire:comments.comment-section"
  key_links:
    - from: "resources/views/posts/show.blade.php"
      to: "App\\Livewire\\Comments\\CommentSection"
      via: "Livewire component tag"
      pattern: "<livewire:comments.comment-section"
---

<objective>
Integrate comment section into post view and verify complete comment system

Purpose: Connect all comment components to live posts and validate end-to-end functionality
Output: Working comment system visible on post pages, verified by human testing
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comment-system/04-RESEARCH.md
@.planning/phases/04-comment-system/04-03-SUMMARY.md
@.planning/phases/04-comment-system/04-04-SUMMARY.md

@resources/views/posts/show.blade.php
@app/Livewire/Comments/CommentSection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate comment section into post view</name>
  <files>resources/views/posts/show.blade.php</files>
  <action>
Update `resources/views/posts/show.blade.php` to include the comment section after the article content.

Add after the closing `</article>` tag but before `</x-layout>`:

```blade
{{-- Comments section --}}
<section class="max-w-4xl mx-auto mt-12 pt-8 border-t border-gray-200">
    <livewire:comments.comment-section :post="$post" />
</section>
```

The complete file should look like:
```blade
<x-layout>
    <article class="max-w-4xl mx-auto">
        {{-- existing header and content --}}
    </article>

    {{-- Comments section --}}
    <section class="max-w-4xl mx-auto mt-12 pt-8 border-t border-gray-200">
        <livewire:comments.comment-section :post="$post" />
    </section>
</x-layout>
```

Key integration points:
- Same max-width as article (max-w-4xl) for visual consistency
- Border-t separates comments from article content
- `:post="$post"` passes the Post model to the Livewire component
  </action>
  <verify>
Run `grep "livewire:comments.comment-section" resources/views/posts/show.blade.php` - shows component tag
Run `php artisan view:cache && php artisan view:clear` - no view compilation errors
  </verify>
  <done>Comment section integrated into post view template</done>
</task>

<task type="auto">
  <name>Task 2: Verify system integration</name>
  <files>N/A (verification only)</files>
  <action>
Run integration checks to verify the complete comment system works:

1. Clear all caches:
```bash
php artisan cache:clear
php artisan view:clear
php artisan route:clear
php artisan config:clear
```

2. Check Livewire component discovery:
```bash
php artisan livewire:discover
```

3. Run any existing tests:
```bash
php artisan test --filter=Comment
```

4. Start the dev server if not running:
```bash
php artisan serve
```

5. Use tinker to verify a post with comments exists:
```php
php artisan tinker --execute="App\Models\Post::whereHas('comments', fn(\$q) => \$q->approved())->first()?->slug"
```

Report any errors encountered.
  </action>
  <verify>
- `php artisan livewire:discover` completes without errors
- Tests pass (if any exist for comments)
- A post with approved comments can be identified
  </verify>
  <done>Integration verified, no errors in component discovery</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete comment system with threaded display, submission form, moderation, and Gravatar avatars</what-built>
  <how-to-verify>
1. Start dev server: `php artisan serve`

2. Navigate to a post with existing comments (check output from integration task for a slug)
   Example: http://localhost:8000/2015/08/[post-slug]/

3. Verify comment display:
   - [ ] Comments section visible below post content
   - [ ] Comment count shows correctly in header
   - [ ] Gravatar avatars display (gray silhouette for emails without Gravatar)
   - [ ] Threaded replies are indented (if any exist)
   - [ ] Author names, timestamps ("X days ago") display correctly

4. Test comment submission:
   - [ ] Fill in name, email, comment content
   - [ ] Submit the form
   - [ ] See "awaiting moderation" message (first-time commenter)
   - [ ] Verify comment saved in database: `php artisan tinker --execute="App\Models\Comment::latest()->first()"`

5. Test reply functionality:
   - [ ] Click "Reply" on an existing comment
   - [ ] Reply form appears below that comment
   - [ ] "Cancel" button hides the form
   - [ ] Submit a reply (will be pending)

6. Test validation:
   - [ ] Submit empty form - see validation errors
   - [ ] Enter invalid email - see error message
   - [ ] Very short comment (1-2 chars) - see minimum length error

7. Visual check:
   - [ ] Styling consistent with rest of site
   - [ ] Mobile responsive (resize browser or use dev tools)
   - [ ] No layout breaks or overflow issues
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Comment section renders on post pages
- Existing comments display with proper threading
- New comments can be submitted
- Validation errors display correctly
- Rate limiting and honeypot active (test by submitting >5 times rapidly)
</verification>

<success_criteria>
1. Comments section appears below posts
2. Existing approved comments display with Gravatar avatars
3. Threaded replies properly indented (up to 3 levels)
4. New comments submit successfully with pending status
5. Previously approved email addresses auto-approve
6. Form validation displays inline errors
7. Visual design consistent with site branding
</success_criteria>

<output>
After completion, create `.planning/phases/04-comment-system/04-05-SUMMARY.md`
</output>
