---
phase: 01-data-migration-models
plan: 06
type: execute
wave: 5
depends_on: ["01-05"]
files_modified:
  - database/seeders/CommentSeeder.php
  - database/seeders/DatabaseSeeder.php
autonomous: true

must_haves:
  truths:
    - "All 160,569 approved comments exist in Laravel comments table"
    - "Comment threading preserved (parent_id relationships correct)"
    - "Comments linked to correct posts via post_id"
    - "Root comments have parent_id = null"
  artifacts:
    - path: "database/seeders/CommentSeeder.php"
      provides: "Comment migration seeder with chunking"
      contains: "chunk(1000"
  key_links:
    - from: "database/seeders/CommentSeeder.php"
      to: "app/Models/Comment.php"
      via: "batch inserts comments"
      pattern: "Comment::upsert"
    - from: "database/seeders/CommentSeeder.php"
      to: "app/Models/WordPress/WpComment.php"
      via: "reads WordPress comments"
      pattern: "WpComment::approved"
---

<objective>
Create chunked comment seeder for 160K+ WordPress comments with threading preservation.

Purpose: Comments are the largest dataset (160,569 records). Requires careful chunking and memory management. Threading must be preserved exactly.
Output: CommentSeeder that migrates all approved comments with parent-child relationships intact.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-migration-models/01-RESEARCH.md
@app/Models/WordPress/WpComment.php
@app/Models/Comment.php
@app/Models/Post.php
@app/Models/User.php

# Critical data:
# - Comments: 160,569 approved
# - Must use chunking (1000 records per batch)
# - Threading: WordPress comment_parent maps to parent_id
# - comment_parent = 0 means root comment (map to null)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Comment Seeder with Chunking</name>
  <files>
    database/seeders/CommentSeeder.php
  </files>
  <action>
Create CommentSeeder optimized for 160K+ records:

```php
<?php

namespace Database\Seeders;

use App\Models\Comment;
use App\Models\Post;
use App\Models\User;
use App\Models\WordPress\WpComment;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;

class CommentSeeder extends Seeder
{
    public function run(): void
    {
        $this->command->info('Migrating WordPress comments (this may take several minutes)...');

        // Build lookup maps
        $postMap = Post::pluck('id', 'wordpress_id')->toArray();
        $userMap = User::whereNotNull('wordpress_id')
            ->pluck('id', 'wordpress_id')
            ->toArray();

        // Pre-fetch all WordPress comment IDs for parent mapping
        // This is needed because we'll insert in chunks and need to map parent_id
        $wpCommentIdToLaravelId = [];

        $total = WpComment::approved()->count();
        $bar = $this->command->getOutput()->createProgressBar($total);
        $bar->start();

        // PASS 1: Insert all comments (parent_id = null initially)
        // We can't set parent_id during insert because child might process before parent
        WpComment::approved()
            ->orderBy('comment_ID', 'asc')
            ->chunk(1000, function ($wpComments) use ($postMap, $userMap, &$wpCommentIdToLaravelId, $bar) {
                $commentsData = [];

                foreach ($wpComments as $wpComment) {
                    $laravelPostId = $postMap[$wpComment->comment_post_ID] ?? null;

                    if (!$laravelPostId) {
                        // Comment for unpublished/non-existent post, skip
                        $bar->advance();
                        continue;
                    }

                    // Map WordPress user_id to Laravel user_id (0 = guest commenter)
                    $userId = null;
                    if ($wpComment->user_id > 0) {
                        $userId = $userMap[$wpComment->user_id] ?? null;
                    }

                    $commentsData[] = [
                        'wordpress_id' => $wpComment->comment_ID,
                        'post_id' => $laravelPostId,
                        'user_id' => $userId,
                        'parent_id' => null, // Set in pass 2
                        'author_name' => $wpComment->comment_author ?: 'Anonymous',
                        'author_email' => $wpComment->comment_author_email ?: '',
                        'author_url' => $wpComment->comment_author_url ?: null,
                        'author_ip' => $wpComment->comment_author_IP ?: null,
                        'content' => $wpComment->comment_content,
                        'status' => 'approved',
                        'created_at' => $wpComment->comment_date,
                        'updated_at' => $wpComment->comment_date,
                    ];
                }

                if (!empty($commentsData)) {
                    Comment::upsert(
                        $commentsData,
                        ['wordpress_id'],
                        ['post_id', 'user_id', 'author_name', 'author_email', 'author_url', 'author_ip', 'content', 'status', 'updated_at']
                    );
                }

                $bar->advance(count($commentsData));
            });

        $bar->finish();
        $this->command->newLine();

        // Build WordPress ID -> Laravel ID map for parent resolution
        $this->command->info('Building comment ID mapping for threading...');
        $wpCommentIdToLaravelId = Comment::pluck('id', 'wordpress_id')->toArray();

        // PASS 2: Update parent_id for threaded comments
        $this->command->info('Updating parent references for comment threading...');

        $threadsUpdated = 0;
        WpComment::approved()
            ->where('comment_parent', '>', 0) // Only comments that have a parent
            ->chunk(1000, function ($wpComments) use ($wpCommentIdToLaravelId, &$threadsUpdated) {
                foreach ($wpComments as $wpComment) {
                    $laravelCommentId = $wpCommentIdToLaravelId[$wpComment->comment_ID] ?? null;
                    $laravelParentId = $wpCommentIdToLaravelId[$wpComment->comment_parent] ?? null;

                    if ($laravelCommentId && $laravelParentId) {
                        Comment::where('id', $laravelCommentId)
                            ->update(['parent_id' => $laravelParentId]);
                        $threadsUpdated++;
                    }
                }
            });

        $totalMigrated = Comment::count();
        $rootComments = Comment::whereNull('parent_id')->count();
        $repliedComments = Comment::whereNotNull('parent_id')->count();

        $this->command->info("Migration complete:");
        $this->command->info("  Total comments: {$totalMigrated}");
        $this->command->info("  Root comments: {$rootComments}");
        $this->command->info("  Replies (threaded): {$repliedComments}");
    }
}
```

Key implementation details:
1. **Two-pass approach**: Insert all comments first with parent_id=null, then update parent_id. This handles cases where child comment processes before parent.
2. **Chunking at 1000 records**: Balances memory usage vs. database round trips for 160K records.
3. **Map building**: Creates WordPress ID -> Laravel ID map for efficient parent resolution.
4. **Guest commenters**: WordPress user_id=0 means anonymous/guest commenter, map to null in Laravel.
5. **Idempotent**: Uses upsert so safe to re-run.
6. **Progress reporting**: Shows progress bar and final statistics.
  </action>
  <verify>
Run: `php artisan db:seed --class=CommentSeeder`
Expected output shows:
- Progress bar completing
- "Total comments: ~160569"
- "Root comments: X"
- "Replies (threaded): Y" where X + Y = total
  </verify>
  <done>
CommentSeeder migrates 160K+ comments with threading preserved using two-pass approach.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DatabaseSeeder and Verify Threading</name>
  <files>
    database/seeders/DatabaseSeeder.php
  </files>
  <action>
Update DatabaseSeeder to include CommentSeeder as final phase:

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     *
     * Order matters - dependencies must be seeded first:
     * 1. Users (authors for posts)
     * 2. Categories and Tags (taxonomy for posts)
     * 3. Posts and Pages (content)
     * 4. Taxonomy Relationships (links posts to categories/tags)
     * 5. Comments (references posts, users, and other comments)
     */
    public function run(): void
    {
        $this->command->info('');
        $this->command->info('╔═══════════════════════════════════════╗');
        $this->command->info('║   WordPress to Laravel Migration      ║');
        $this->command->info('╚═══════════════════════════════════════╝');
        $this->command->newLine();

        // Phase 1: Foundation (no dependencies)
        $this->command->info('Phase 1: Users & Taxonomies');
        $this->call([
            UserSeeder::class,
            CategorySeeder::class,
            TagSeeder::class,
        ]);

        // Phase 2: Content (depends on users and taxonomies)
        $this->command->newLine();
        $this->command->info('Phase 2: Content');
        $this->call([
            PostSeeder::class,
            PageSeeder::class,
            TaxonomyRelationshipSeeder::class,
        ]);

        // Phase 3: Engagement (depends on posts and users)
        $this->command->newLine();
        $this->command->info('Phase 3: Comments');
        $this->call([
            CommentSeeder::class,
        ]);

        $this->command->newLine();
        $this->command->info('╔═══════════════════════════════════════╗');
        $this->command->info('║   Migration Complete!                 ║');
        $this->command->info('╚═══════════════════════════════════════╝');
        $this->command->newLine();

        // Print final statistics
        $this->printStatistics();
    }

    private function printStatistics(): void
    {
        $this->command->info('Final Statistics:');
        $this->command->table(
            ['Entity', 'Count'],
            [
                ['Users', \App\Models\User::count()],
                ['Categories', \App\Models\Category::count()],
                ['Tags', \App\Models\Tag::count()],
                ['Posts', \App\Models\Post::count()],
                ['Pages', \App\Models\Page::count()],
                ['Comments', \App\Models\Comment::count()],
                ['Comment Threads', \App\Models\Comment::whereNotNull('parent_id')->count()],
            ]
        );
    }
}
```
  </action>
  <verify>
Run full migration: `php artisan migrate:fresh && php artisan db:seed`

Expected output:
- All phases complete without errors
- Final statistics table shows expected counts
- Comments threaded count > 0

Verify threading works:
```bash
php artisan tinker --execute="
\$post = App\Models\Post::has('comments')->first();
echo 'Post: ' . \$post->title . PHP_EOL;
echo 'Total comments: ' . \$post->comments()->count() . PHP_EOL;
echo 'Root comments: ' . \$post->comments()->rootComments()->count() . PHP_EOL;
\$root = \$post->comments()->rootComments()->has('replies')->first();
if (\$root) {
    echo 'Sample root comment ID: ' . \$root->id . PHP_EOL;
    echo 'Replies count: ' . \$root->replies()->count() . PHP_EOL;
}
"
```
  </verify>
  <done>
DatabaseSeeder complete with all phases and final statistics. Comment threading verified.
  </done>
</task>

</tasks>

<verification>
1. `php artisan db:seed --class=CommentSeeder` completes without memory errors
2. Laravel comments table has ~160,569 records
3. Comments with parent_id (threaded replies) exist
4. Root comments have parent_id = null
5. `Post::first()->comments()->rootComments()->first()->replies` returns replies
6. `Comment::where('id', X)->parent` returns parent comment for threaded comments
7. Full migration `php artisan migrate:fresh && php artisan db:seed` completes successfully
</verification>

<success_criteria>
- All ~160,569 approved comments migrated
- Comment threading preserved (parent-child relationships work)
- Guest commenters handled (user_id = null)
- Orphaned comments (for unpublished posts) skipped
- Two-pass approach handles any comment ordering in source
- Memory stays bounded with 1000-record chunks
- Full migration runs end-to-end without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-models/01-06-SUMMARY.md`
</output>
