---
phase: 01-data-migration-models
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/2026_01_24_000001_extend_users_table.php
  - database/migrations/2026_01_24_000002_create_posts_table.php
  - database/migrations/2026_01_24_000003_create_pages_table.php
  - database/migrations/2026_01_24_000004_create_categories_table.php
  - database/migrations/2026_01_24_000005_create_tags_table.php
  - database/migrations/2026_01_24_000006_create_taggables_table.php
  - database/migrations/2026_01_24_000007_create_categorizables_table.php
  - database/migrations/2026_01_24_000008_create_comments_table.php
autonomous: true

must_haves:
  truths:
    - "All Laravel tables created with correct columns and indexes"
    - "Foreign key constraints enforce referential integrity"
    - "Users table has author_name and wordpress_id columns"
    - "Comments table supports self-referencing for threading"
  artifacts:
    - path: "database/migrations/2026_01_24_000001_extend_users_table.php"
      provides: "User table extension for WordPress fields"
      contains: "author_name"
    - path: "database/migrations/2026_01_24_000002_create_posts_table.php"
      provides: "Posts table schema"
      contains: "Schema::create('posts'"
    - path: "database/migrations/2026_01_24_000008_create_comments_table.php"
      provides: "Comments table with threading"
      contains: "parent_id"
  key_links:
    - from: "posts table"
      to: "users table"
      via: "user_id foreign key"
      pattern: "foreignId.*user_id"
    - from: "comments table"
      to: "comments table"
      via: "parent_id self-reference"
      pattern: "foreignId.*parent_id.*constrained.*comments"
---

<objective>
Create all Laravel database migrations for the target schema.

Purpose: Establishes the target database structure. Without these tables, seeders cannot write migrated data.
Output: 8 migration files creating users extension, posts, pages, categories, tags, pivot tables, and comments.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-migration-models/01-RESEARCH.md

# Key constraints from user:
# - SKIP password migration (user handles manually)
# - User model needs: author_name (display name), wordpress_id (map content to authors)
# - WordPress permalink: /%year%/%monthnum%/%day%/%postname%/ (need published_at for URL generation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Table Extension Migration</name>
  <files>
    database/migrations/2026_01_24_000001_extend_users_table.php
  </files>
  <action>
Create migration to ADD columns to existing users table (do NOT recreate it):

```php
Schema::table('users', function (Blueprint $table) {
    $table->string('author_name')->nullable()->after('name');
    $table->unsignedBigInteger('wordpress_id')->nullable()->unique()->after('author_name');
    $table->string('role')->default('author')->after('wordpress_id'); // administrator, editor, author
});
```

The 'name' column already exists (full name). 'author_name' is the display name/nickname for bylines.

Do NOT add password fields - user explicitly said they'll handle password migration manually.
  </action>
  <verify>
Run: `php artisan migrate --pretend` shows the ALTER TABLE statement for users
  </verify>
  <done>
Users table extended with author_name, wordpress_id, and role columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Content and Taxonomy Migrations</name>
  <files>
    database/migrations/2026_01_24_000002_create_posts_table.php
    database/migrations/2026_01_24_000003_create_pages_table.php
    database/migrations/2026_01_24_000004_create_categories_table.php
    database/migrations/2026_01_24_000005_create_tags_table.php
    database/migrations/2026_01_24_000006_create_taggables_table.php
    database/migrations/2026_01_24_000007_create_categorizables_table.php
  </files>
  <action>
Create 6 migrations with these schemas:

**posts table:**
```php
Schema::create('posts', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('wordpress_id')->unique(); // Original WP post ID
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('title');
    $table->string('slug');
    $table->longText('content');
    $table->text('excerpt')->nullable();
    $table->string('status')->default('published'); // published, draft, pending
    $table->timestamp('published_at')->nullable();
    $table->timestamps();

    // Indexes for URL routing (year/month/day/slug pattern)
    $table->index(['published_at', 'slug']);
    $table->index('user_id');
});
```

**pages table:**
```php
Schema::create('pages', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('wordpress_id')->unique();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('title');
    $table->string('slug')->unique();
    $table->longText('content');
    $table->integer('menu_order')->default(0);
    $table->timestamps();

    $table->index('slug');
});
```

**categories table:**
```php
Schema::create('categories', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('wordpress_id')->unique();
    $table->string('name');
    $table->string('slug')->unique();
    $table->text('description')->nullable();
    $table->timestamps();
});
```

**tags table:**
```php
Schema::create('tags', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('wordpress_id')->unique();
    $table->string('name');
    $table->string('slug')->unique();
    $table->timestamps();
});
```

**taggables table (polymorphic pivot):**
```php
Schema::create('taggables', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tag_id')->constrained()->cascadeOnDelete();
    $table->morphs('taggable'); // Creates taggable_id, taggable_type
    $table->timestamps();

    $table->unique(['tag_id', 'taggable_id', 'taggable_type']);
});
```

**categorizables table (polymorphic pivot):**
```php
Schema::create('categorizables', function (Blueprint $table) {
    $table->id();
    $table->foreignId('category_id')->constrained()->cascadeOnDelete();
    $table->morphs('categorizable');
    $table->timestamps();

    $table->unique(['category_id', 'categorizable_id', 'categorizable_type']);
});
```

Use longText for content (not text) - WordPress posts can be very long with embedded HTML/shortcodes.
  </action>
  <verify>
Run: `php artisan migrate --pretend` shows CREATE TABLE statements for all 6 tables
  </verify>
  <done>
Six tables created: posts, pages, categories, tags, taggables, categorizables with correct schemas.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Comments Migration</name>
  <files>
    database/migrations/2026_01_24_000008_create_comments_table.php
  </files>
  <action>
Create comments table with self-referencing for threading:

```php
Schema::create('comments', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('wordpress_id')->unique();
    $table->foreignId('post_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->nullable()->constrained()->nullOnDelete();
    $table->foreignId('parent_id')->nullable()->constrained('comments')->cascadeOnDelete();
    $table->string('author_name');
    $table->string('author_email');
    $table->string('author_url')->nullable();
    $table->string('author_ip', 45)->nullable();
    $table->text('content');
    $table->string('status')->default('approved'); // approved, pending, spam
    $table->timestamps();

    // Critical indexes for 160K+ comments
    $table->index('post_id');
    $table->index('parent_id');
    $table->index('status');
    $table->index(['post_id', 'status', 'created_at']); // For displaying approved comments chronologically
});
```

The parent_id self-reference enables WordPress comment threading. parent_id=null means root comment.

Indexes are critical with 160K+ records - without them, queries will be very slow.
  </action>
  <verify>
Run: `php artisan migrate --pretend` shows CREATE TABLE for comments with parent_id foreign key to comments table
  </verify>
  <done>
Comments table created with self-referencing parent_id for threading and appropriate indexes for large dataset.
  </done>
</task>

</tasks>

<verification>
1. `php artisan migrate --pretend` shows all 8 migrations will run successfully
2. `php artisan migrate` executes without errors (creates all tables)
3. `php artisan db:table users` shows author_name, wordpress_id, role columns
4. `php artisan db:table comments` shows parent_id column with foreign key to comments
5. All tables have appropriate indexes as specified
</verification>

<success_criteria>
- 8 migration files created with correct schemas
- Users table extended with author_name, wordpress_id, role (no password changes)
- Posts and pages tables include wordpress_id for mapping
- Comments table has self-referencing parent_id for threading
- Polymorphic pivot tables (taggables, categorizables) created
- All foreign key constraints defined
- Critical indexes added for performance
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-models/01-02-SUMMARY.md`
</output>
