---
phase: 01-data-migration-models
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - database/seeders/UserSeeder.php
  - database/seeders/CategorySeeder.php
  - database/seeders/TagSeeder.php
  - database/seeders/DatabaseSeeder.php
autonomous: true

must_haves:
  truths:
    - "All 12 WordPress users exist in Laravel users table"
    - "All 14 categories exist in Laravel categories table"
    - "All 15,448 tags exist in Laravel tags table"
    - "User roles mapped correctly (Administrator, Editor, Author)"
  artifacts:
    - path: "database/seeders/UserSeeder.php"
      provides: "User migration seeder"
      contains: "WpUser"
    - path: "database/seeders/TagSeeder.php"
      provides: "Tag migration seeder with chunking"
      contains: "chunk"
    - path: "database/seeders/CategorySeeder.php"
      provides: "Category migration seeder"
      contains: "WpTermTaxonomy"
  key_links:
    - from: "database/seeders/UserSeeder.php"
      to: "app/Models/WordPress/WpUser.php"
      via: "reads WordPress users"
      pattern: "WpUser::"
    - from: "database/seeders/TagSeeder.php"
      to: "app/Models/Tag.php"
      via: "inserts into Laravel tags"
      pattern: "Tag::insert"
---

<objective>
Create seeders for users, categories, and tags with WordPress role mapping.

Purpose: These are foundational data that posts and comments depend on. Users must exist before posts (author FK), categories/tags must exist before taxonomy relationships.
Output: 3 seeders (UserSeeder, CategorySeeder, TagSeeder) + updated DatabaseSeeder.
</objective>

<execution_context>
@/Users/shoemoney/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shoemoney/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-migration-models/01-RESEARCH.md
@app/Models/WordPress/WpUser.php
@app/Models/WordPress/WpTermTaxonomy.php
@app/Models/User.php
@app/Models/Tag.php
@app/Models/Category.php

# Data volumes:
# - Users: 12 (small, no chunking needed)
# - Categories: 14 (small, no chunking needed)
# - Tags: 15,448 (needs chunking)

# User clarification:
# - SKIP password migration - user handles manually
# - Map WordPress roles: Administrator, Editor, Author
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Seeder with Role Mapping</name>
  <files>
    database/seeders/UserSeeder.php
  </files>
  <action>
Create UserSeeder that:
1. Reads all users from WordPress wp2_users
2. Maps WordPress roles to Laravel roles
3. Inserts into Laravel users table (SKIPPING password - set to random hash)

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use App\Models\WordPress\WpUser;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class UserSeeder extends Seeder
{
    /**
     * WordPress capability to Laravel role mapping.
     * WordPress stores roles in usermeta as serialized array.
     */
    private function mapWordPressRole(string $capabilities): string
    {
        // WordPress stores roles as serialized array: a:1:{s:13:"administrator";b:1;}
        if (str_contains($capabilities, 'administrator')) {
            return User::ROLE_ADMINISTRATOR;
        }
        if (str_contains($capabilities, 'editor')) {
            return User::ROLE_EDITOR;
        }
        return User::ROLE_AUTHOR;
    }

    public function run(): void
    {
        $this->command->info('Migrating WordPress users...');

        // Get wp2_ prefix capabilities meta key
        $capabilitiesKey = 'wp2_capabilities';

        $wpUsers = WpUser::all();

        foreach ($wpUsers as $wpUser) {
            // Get user capabilities from usermeta
            $capsMeta = DB::connection('wordpress')
                ->table('usermeta')
                ->where('user_id', $wpUser->ID)
                ->where('meta_key', $capabilitiesKey)
                ->value('meta_value');

            $role = $this->mapWordPressRole($capsMeta ?? '');

            User::updateOrCreate(
                ['wordpress_id' => $wpUser->ID],
                [
                    'name' => $wpUser->display_name,
                    'author_name' => $wpUser->user_nicename,
                    'email' => $wpUser->user_email,
                    'password' => Str::random(60), // Placeholder - user handles password migration manually
                    'role' => $role,
                    'created_at' => $wpUser->user_registered,
                    'updated_at' => now(),
                ]
            );

            $this->command->info("  Migrated: {$wpUser->display_name} ({$role})");
        }

        $this->command->info("Migrated {$wpUsers->count()} users.");
    }
}
```

Key points:
- Uses updateOrCreate so seeder is idempotent (safe to re-run)
- Password set to random string - user explicitly said they'll handle password migration
- WordPress role detected from serialized usermeta, not from a roles table
- The wp2_ prefix is important for the capabilities meta key
  </action>
  <verify>
Run: `php artisan db:seed --class=UserSeeder` should show "Migrated 12 users" with role assignments
  </verify>
  <done>
UserSeeder creates all WordPress users with mapped roles. Passwords are placeholders (user handles manually).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Category and Tag Seeders</name>
  <files>
    database/seeders/CategorySeeder.php
    database/seeders/TagSeeder.php
  </files>
  <action>
**CategorySeeder.php:**
```php
<?php

namespace Database\Seeders;

use App\Models\Category;
use App\Models\WordPress\WpTermTaxonomy;
use Illuminate\Database\Seeder;

class CategorySeeder extends Seeder
{
    public function run(): void
    {
        $this->command->info('Migrating WordPress categories...');

        $wpCategories = WpTermTaxonomy::categories()
            ->with('term')
            ->get();

        foreach ($wpCategories as $wpCat) {
            Category::updateOrCreate(
                ['wordpress_id' => $wpCat->term_taxonomy_id],
                [
                    'name' => $wpCat->term->name,
                    'slug' => $wpCat->term->slug,
                    'description' => $wpCat->description ?: null,
                ]
            );
        }

        $this->command->info("Migrated {$wpCategories->count()} categories.");
    }
}
```

**TagSeeder.php:**
```php
<?php

namespace Database\Seeders;

use App\Models\Tag;
use App\Models\WordPress\WpTermTaxonomy;
use Illuminate\Database\Seeder;

class TagSeeder extends Seeder
{
    public function run(): void
    {
        $this->command->info('Migrating WordPress tags...');

        $total = WpTermTaxonomy::tags()->count();
        $bar = $this->command->getOutput()->createProgressBar($total);
        $bar->start();

        // Chunk for 15K+ tags to avoid memory issues
        WpTermTaxonomy::tags()
            ->with('term')
            ->chunk(500, function ($wpTags) use ($bar) {
                $tagsData = [];

                foreach ($wpTags as $wpTag) {
                    $tagsData[] = [
                        'wordpress_id' => $wpTag->term_taxonomy_id,
                        'name' => $wpTag->term->name,
                        'slug' => $wpTag->term->slug,
                        'created_at' => now(),
                        'updated_at' => now(),
                    ];
                }

                // Use upsert for idempotency (safe to re-run)
                Tag::upsert(
                    $tagsData,
                    ['wordpress_id'], // Unique key
                    ['name', 'slug', 'updated_at'] // Update these on conflict
                );

                $bar->advance(count($tagsData));
            });

        $bar->finish();
        $this->command->newLine();
        $this->command->info("Migrated {$total} tags.");
    }
}
```

Key differences:
- CategorySeeder uses simple foreach (only 14 categories)
- TagSeeder uses chunk() with progress bar (15K+ tags)
- Both use upsert/updateOrCreate for idempotency
- wordpress_id is term_taxonomy_id (not term_id) per research
  </action>
  <verify>
Run:
- `php artisan db:seed --class=CategorySeeder` shows "Migrated 14 categories"
- `php artisan db:seed --class=TagSeeder` shows progress bar and "Migrated 15448 tags" (approximately)
  </verify>
  <done>
CategorySeeder and TagSeeder created. Tags use chunking for large dataset. Both are idempotent.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DatabaseSeeder</name>
  <files>
    database/seeders/DatabaseSeeder.php
  </files>
  <action>
Update DatabaseSeeder to call seeders in dependency order:

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     *
     * Order matters: Users and taxonomies must exist before posts.
     * Posts must exist before comments and taxonomy relationships.
     */
    public function run(): void
    {
        $this->command->info('=== WordPress Migration Seeders ===');
        $this->command->newLine();

        // Phase 1: Foundation (no dependencies)
        $this->call([
            UserSeeder::class,
            CategorySeeder::class,
            TagSeeder::class,
        ]);

        // Phase 2: Content (depends on users and taxonomies)
        // PostSeeder, PageSeeder, TaxonomyRelationshipSeeder
        // Added in Plan 05

        // Phase 3: Engagement (depends on posts)
        // CommentSeeder
        // Added in Plan 06

        $this->command->newLine();
        $this->command->info('=== Migration Complete ===');
    }
}
```

This establishes the structure. Plans 05 and 06 will add PostSeeder, PageSeeder, TaxonomyRelationshipSeeder, and CommentSeeder.
  </action>
  <verify>
Run: `php artisan db:seed` executes UserSeeder, CategorySeeder, TagSeeder in order without errors
  </verify>
  <done>
DatabaseSeeder updated with correct dependency order and structure for future seeder additions.
  </done>
</task>

</tasks>

<verification>
1. `php artisan db:seed --class=UserSeeder` creates 12 users with correct roles
2. `php artisan db:seed --class=CategorySeeder` creates 14 categories
3. `php artisan db:seed --class=TagSeeder` creates ~15,448 tags with progress bar
4. Laravel users table has wordpress_id, author_name, role columns populated
5. Re-running seeders updates existing records (idempotent)
6. `php artisan db:seed` runs all three seeders in order
</verification>

<success_criteria>
- 12 WordPress users migrated with correct role mapping
- 14 categories migrated with names, slugs, descriptions
- ~15,448 tags migrated using chunked processing
- All seeders are idempotent (safe to re-run)
- DatabaseSeeder orchestrates seeders in dependency order
- No password data transferred (placeholder passwords used)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-models/01-04-SUMMARY.md`
</output>
